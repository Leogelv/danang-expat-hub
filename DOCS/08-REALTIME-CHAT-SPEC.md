# Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ P2P Ñ‡Ğ°Ñ‚Ğ° Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¾Ğ¼ â€” Danang Expat Hub

> **Last Verified:** 2026-02-17

---

## Ğ’Ğ¸Ğ·Ğ¸Ğ¾Ğ½erÑĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ

ĞŸÑ€ĞµĞ´ÑÑ‚Ğ°Ğ²ÑŒ: Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¸Ğ¹ Ğ»ĞµĞ½Ğ´Ğ»Ğ¾Ñ€Ğ´ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰Ğ°ĞµÑ‚ ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ñƒ. Ğ­ĞºÑĞ¿Ğ°Ñ‚ Ğ¸Ğ· Ğ Ğ¾ÑÑĞ¸Ğ¸ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ". ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‡Ğ°Ñ‚. Ğ­ĞºÑĞ¿Ğ°Ñ‚ Ğ¿Ğ¸ÑˆĞµÑ‚ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸ â€” Ğ»ĞµĞ½Ğ´Ğ»Ğ¾Ñ€Ğ´ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¾Ğ¼. Ğ›ĞµĞ½Ğ´Ğ»Ğ¾Ñ€Ğ´ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğ¼ Ğ½Ğ° Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¾Ğ¼ â€” ÑĞºÑĞ¿Ğ°Ñ‚ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¾Ğ¼ + Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑĞ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ». Ğ’Ğ½Ğ¸Ğ·Ñƒ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ â€” Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¸Ğ¹ Ñ„Ğ»Ğ°Ğ³ (ğŸ‡·ğŸ‡º/ğŸ‡»ğŸ‡³), Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ».

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:** Ğ¯Ğ·Ñ‹ĞºĞ¾Ğ²Ğ¾Ğ¹ Ğ±Ğ°Ñ€ÑŒĞµÑ€ = 0. Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼Ñ†Ğ°Ğ¼ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ°Ğ½Ğ³Ğ»Ğ¸Ğ¹ÑĞºĞ¸Ğ¹. Ğ­ĞºÑĞ¿Ğ°Ñ‚Ğ°Ğ¼ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¸Ğ¹.

---

## ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğµ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 1: ĞÑ€ĞµĞ½Ğ´Ğ° ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ñ‹
```
Ğ­ĞºÑĞ¿Ğ°Ñ‚ (EN) Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ /rentals
    â†’ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ "2BR apartment Son Tra $350"
    â†’ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ "Chat" Ğ½Ğ° ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ
    â†’ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ chat_room Ñ context: listing_id
    â†’ ÑˆĞ°Ğ¿ĞºĞ° Ñ‡Ğ°Ñ‚Ğ°: Ñ„Ğ¾Ñ‚Ğ¾ ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ñ‹ + Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ + Ñ†ĞµĞ½Ğ°
    â†’ Ğ¿Ğ¸ÑˆĞµÑ‚: "Is this still available? Can I see it tomorrow?"
    â†’ Ğ»ĞµĞ½Ğ´Ğ»Ğ¾Ñ€Ğ´ (VI) Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚: "CÄƒn há»™ nÃ y cÃ²n trá»‘ng khÃ´ng? TÃ´i cÃ³ thá»ƒ xem ngÃ y mai khÃ´ng?"
    â†’ Ğ»ĞµĞ½Ğ´Ğ»Ğ¾Ñ€Ğ´ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğ¼ Ğ½Ğ° Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¾Ğ¼
    â†’ ÑĞºÑĞ¿Ğ°Ñ‚ Ğ²Ğ¸Ğ´Ğ¸Ñ‚: [â–¶ 0:08] "Yes, available. Come at 3pm, address is..."
    â†’ Ğ²Ğ½Ğ¸Ğ·Ñƒ: ğŸ‡»ğŸ‡³ tap to see original
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 2: ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° Ğ½Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğµ
```
Ğ­ĞºÑĞ¿Ğ°Ñ‚ (RU) â†’ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ "iPhone 14 Pro - $400"
    â†’ "ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²Ñ†Ñƒ"
    â†’ Ğ¿Ğ¸ÑˆĞµÑ‚: "ĞœĞ¾Ğ¶Ğ½Ğ¾ ÑĞºĞ¸Ğ½ÑƒÑ‚ÑŒ Ğ´Ğ¾ 350?"
    â†’ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ† (EN) Ğ²Ğ¸Ğ´Ğ¸Ñ‚: "Can you do $350?"
    â†’ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ²ĞµÑ†: "Meet me at Vincom, $370 last price"
    â†’ ÑĞºÑĞ¿Ğ°Ñ‚ Ğ²Ğ¸Ğ´Ğ¸Ñ‚: "Ğ’ÑÑ‚Ñ€ĞµÑ‡Ğ°ĞµĞ¼ÑÑ Ğ² Vincom, $370 Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ†ĞµĞ½Ğ°"
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 3: Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
```
Ğ’ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ĞµÑ† (VI) â†’ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ "Xin chÃ o, cÄƒn há»™ nÃ y..."
    â†“
STT (Whisper): Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° Ğ²ÑŒĞµÑ‚Ğ½Ğ°Ğ¼ÑĞºĞ¾Ğ¼
    â†“
ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´: Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»Ñ
    â†“
ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â–¶ 0:12] â•â•â•â•â•â•â•â•â•â•â•â• ğŸ”Š       â”‚
â”‚ "Hello, this apartment..."      â”‚
â”‚ ğŸ‡»ğŸ‡³ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ‘Ğ”

```sql
-- ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹ Ñ‡Ğ°Ñ‚Ğ°
CREATE TABLE chat_rooms (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    type text NOT NULL DEFAULT 'direct' CHECK (type IN ('direct', 'group')),
    -- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ (Ğº Ñ‡ĞµĞ¼Ñƒ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½ Ñ‡Ğ°Ñ‚)
    context_type text CHECK (context_type IN ('listing', 'market_item', 'place', 'event', NULL)),
    context_id uuid,
    -- ĞœĞµÑ‚Ğ°
    title text,                      -- Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);

-- Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ Ñ‡Ğ°Ñ‚Ğ°
CREATE TABLE chat_participants (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id uuid NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
    user_id uuid NOT NULL REFERENCES tg_users(id) ON DELETE CASCADE,
    role text DEFAULT 'member' CHECK (role IN ('member', 'admin', 'owner')),
    preferred_language text DEFAULT 'en' CHECK (preferred_language IN ('en', 'ru', 'uk', 'vi')),
    last_read_at timestamptz,
    joined_at timestamptz DEFAULT now(),
    UNIQUE(room_id, user_id)
);

-- Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
CREATE TABLE chat_messages (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id uuid NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
    sender_id uuid NOT NULL REFERENCES tg_users(id),
    -- ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
    type text NOT NULL DEFAULT 'text' CHECK (type IN ('text', 'voice', 'image', 'system')),
    content text,                      -- Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ
    original_language text,            -- ÑĞ·Ñ‹Ğº Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ğ° (auto-detected Ğ¸Ğ»Ğ¸ Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)
    -- ĞœĞµĞ´Ğ¸Ğ°
    media_url text,                    -- URL Ğ´Ğ»Ñ voice/image
    media_duration integer,            -- Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ…
    -- ĞœĞµÑ‚Ğ°
    reply_to_id uuid REFERENCES chat_messages(id),
    is_deleted boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
);

-- ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (ĞºÑÑˆ)
CREATE TABLE chat_message_translations (
    id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id uuid NOT NULL REFERENCES chat_messages(id) ON DELETE CASCADE,
    target_language text NOT NULL CHECK (target_language IN ('en', 'ru', 'uk', 'vi')),
    translated_text text NOT NULL,
    created_at timestamptz DEFAULT now(),
    UNIQUE(message_id, target_language)
);

-- RLS
ALTER TABLE chat_rooms ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_participants ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_message_translations ENABLE ROW LEVEL SECURITY;

-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ¸ Ñ‡Ğ°Ñ‚Ñ‹
CREATE POLICY "Users see own rooms" ON chat_rooms FOR SELECT
    USING (id IN (SELECT room_id FROM chat_participants WHERE user_id = auth.uid()));

-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² ÑĞ²Ğ¾Ğ¸Ñ… Ñ‡Ğ°Ñ‚Ğ¾Ğ²
CREATE POLICY "Users see own participants" ON chat_participants FOR SELECT
    USING (room_id IN (SELECT room_id FROM chat_participants WHERE user_id = auth.uid()));

-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² ÑĞ²Ğ¾Ğ¸Ñ… Ñ‡Ğ°Ñ‚Ğ°Ñ…
CREATE POLICY "Users see own messages" ON chat_messages FOR SELECT
    USING (room_id IN (SELECT room_id FROM chat_participants WHERE user_id = auth.uid()));

-- Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹
CREATE INDEX chat_messages_room_idx ON chat_messages(room_id, created_at DESC);
CREATE INDEX chat_participants_user_idx ON chat_participants(user_id);
CREATE INDEX chat_participants_room_idx ON chat_participants(room_id);
CREATE INDEX chat_translations_lookup_idx ON chat_message_translations(message_id, target_language);
```

---

## API Endpoints

### POST `/api/chat/rooms`
Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñƒ Ñ‡Ğ°Ñ‚Ğ° (Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğµ).
```json
Request:
{
  "participantIds": ["uuid-user-1", "uuid-user-2"],
  "contextType": "listing",
  "contextId": "uuid-listing"
}

Response:
{ "room": { "id": "uuid", "type": "direct", ... } }
```

### GET `/api/chat/rooms`
Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ñ last message Ğ¸ unread count.
```json
Response:
{
  "rooms": [{
    "id": "uuid",
    "participant": { "name": "Nguyen Van A", "photo": "..." },
    "context": { "type": "listing", "title": "2BR Son Tra", "image": "..." },
    "lastMessage": { "content": "See you tomorrow", "createdAt": "..." },
    "unreadCount": 2
  }]
}
```

### GET `/api/chat/rooms/[id]/messages?limit=50&before=cursor`
Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğµ (cursor-based pagination).
```json
Response:
{
  "messages": [{
    "id": "uuid",
    "sender": { "name": "John", "photo": "..." },
    "type": "text",
    "content": "Is this still available?",
    "originalLanguage": "en",
    "translation": "CÄƒn há»™ nÃ y cÃ²n trá»‘ng khÃ´ng?",
    "translationLanguage": "vi",
    "createdAt": "..."
  }],
  "hasMore": true,
  "nextCursor": "uuid"
}
```

### POST `/api/chat/rooms/[id]/messages`
ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.
```json
Request:
{
  "type": "text",
  "content": "Hello, is this available?",
  "replyToId": null
}

Response:
{ "message": { ... }, "translations": { "vi": "Xin chÃ o, cÃ¡i nÃ y cÃ²n khÃ´ng?" } }
```

### POST `/api/chat/voice/transcribe`
Ğ¢Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ±Ğ°Ñ†Ğ¸Ñ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.
```json
Request: FormData { audio: Blob, roomId: "uuid" }

Response:
{
  "transcription": "Xin chÃ o, cÄƒn há»™ nÃ y cÃ²n trá»‘ng",
  "sourceLanguage": "vi",
  "translations": {
    "en": "Hello, this apartment is still available",
    "ru": "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, ÑÑ‚Ğ° ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ° ĞµÑ‰Ñ‘ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ°"
  }
}
```

---

## Real-time Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
Client A (sender)
    â”‚
    â”‚ POST /api/chat/rooms/[id]/messages
    â”‚
    â–¼
API Route Handler
    â”‚
    â”œâ”€â”€ 1. INSERT Ğ² chat_messages
    â”œâ”€â”€ 2. Detect language (Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸Ğ»Ğ¸ auto-detect)
    â”œâ”€â”€ 3. Translate Ğ´Ğ»Ñ ĞšĞĞ–Ğ”ĞĞ“Ğ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° (async)
    â”‚       â””â”€â”€ INSERT Ğ² chat_message_translations
    â””â”€â”€ 4. Supabase Realtime broadcast
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Supabase Realtime Channel   â”‚
    â”‚  channel: chat_room_{id}     â”‚
    â”‚                               â”‚
    â”‚  payload: {                   â”‚
    â”‚    message: {...},            â”‚
    â”‚    translations: {            â”‚
    â”‚      "en": "...",             â”‚
    â”‚      "vi": "...",             â”‚
    â”‚      "ru": "..."             â”‚
    â”‚    }                          â”‚
    â”‚  }                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
Client B (receiver)
    â”‚
    â”œâ”€â”€ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· subscription
    â”œâ”€â”€ ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ½Ğ° ÑĞ²Ğ¾Ğ¹ ÑĞ·Ñ‹Ğº
    â””â”€â”€ Ğ¤Ğ»Ğ°Ğ³ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ğ°: ğŸ‡»ğŸ‡³ / ğŸ‡¬ğŸ‡§ / ğŸ‡·ğŸ‡º / ğŸ‡ºğŸ‡¦
```

---

## UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

### ChatRoomsList (Ğ·Ğ°Ğ¼ĞµĞ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ AI Ñ‡Ğ°Ñ‚Ğ° Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ°)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Chats                    [ğŸ¤–]â”‚  â† [ğŸ¤–] = Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ° AI Ñ‡Ğ°Ñ‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â” Nguyen Van A           â”‚
â”‚ â”‚ ğŸ“·  â”‚ 2BR Son Tra Â· $350     â”‚  â† ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
â”‚ â”‚     â”‚ CÄƒn há»™...â†’ "Available" â”‚  â† last message (Ğ¿ĞµÑ€ĞµĞ²ĞµĞ´Ñ‘Ğ½Ğ½Ğ¾Ğµ)
â”‚ â””â”€â”€â”€â”€â”€â”˜              2m ago  â—2â”‚  â† unread badge
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â” Mark Smith             â”‚
â”‚ â”‚ ğŸ“·  â”‚ iPhone 14 Pro          â”‚
â”‚ â”‚     â”‚ "Meet at Vincom"       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜              1h ago    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ChatRoom (Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞºĞ°)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Nguyen Van A                  â”‚
â”‚    2BR apartment Son Tra $350   â”‚  â† ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ»Ğ¸ÑÑ‚Ğ¸Ğ½Ğ³Ğ°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                  â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚        â”‚ Apartment is      â”‚     â”‚
â”‚        â”‚ available, come   â”‚     â”‚
â”‚        â”‚ see at 3pm        â”‚     â”‚
â”‚        â”‚ ğŸ‡»ğŸ‡³ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ       â”‚     â”‚  â† Ñ„Ğ»Ğ°Ğ³ + "Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»"
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚ â”‚ Great! What's the â”‚            â”‚
â”‚ â”‚ exact address?    â”‚            â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                  â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚        â”‚ [â–¶ 0:08] â•â•â• ğŸ”Š â”‚     â”‚  â† Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ğ¾Ğµ
â”‚        â”‚ "It's on Vo Nguyenâ”‚     â”‚  â† Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ + Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´
â”‚        â”‚  Giap street..."  â”‚     â”‚
â”‚        â”‚ ğŸ‡»ğŸ‡³ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ       â”‚     â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ¤] [Type a message...] [ğŸ“] [â¤]â”‚
â”‚                                  â”‚
â”‚ ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹ â–¼                    â”‚  â† Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ ÑĞ·Ñ‹ĞºĞ° Ğ²Ğ²Ğ¾Ğ´Ğ°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»Ğ° (Ğ¿Ğ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Ğ½Ğ° Ñ„Ğ»Ğ°Ğ³)
```
Ğ”Ğ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ:                    ĞŸĞ¾ÑĞ»Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apartment is      â”‚          â”‚ CÄƒn há»™ cÃ²n trá»‘ng,â”‚
â”‚ available, come   â”‚    â†’     â”‚ Ä‘áº¿n xem lÃºc 3    â”‚
â”‚ see at 3pm        â”‚          â”‚ giá» chiá»u         â”‚
â”‚ ğŸ‡»ğŸ‡³ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ       â”‚          â”‚ ğŸ‡¬ğŸ‡§ ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ğ“Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ â€” flow

```
1. User Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ [ğŸ¤] â†’ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ (MediaRecorder API)
2. Ğ£Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ â†’ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ, Ğ¾Ñ‚Ğ¿ÑƒÑĞºĞ°Ğ½Ğ¸Ğµ â†’ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°
3. ĞÑƒĞ´Ğ¸Ğ¾ â†’ Blob â†’ FormData â†’ POST /api/chat/voice/transcribe
4. Server:
   a. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ°ÑƒĞ´Ğ¸Ğ¾ Ğ² Supabase Storage
   b. Whisper API â†’ Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ
   c. Detect language
   d. ĞŸĞµÑ€ĞµĞ²ĞµÑÑ‚Ğ¸ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
   e. INSERT chat_messages (type: 'voice', content: transcription)
   f. INSERT chat_message_translations
   g. Broadcast Ñ‡ĞµÑ€ĞµĞ· Realtime
5. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ñ‚: Ğ°ÑƒĞ´Ğ¸Ğ¾-Ğ¿Ğ»ĞµĞµÑ€ + Ñ‚Ñ€Ğ°Ğ½ÑĞºÑ€Ğ¸Ğ¿Ñ†Ğ¸Ñ Ğ½Ğ° ÑĞ²Ğ¾Ñ‘Ğ¼ ÑĞ·Ñ‹ĞºĞµ
```

### Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ…
- Whisper API: $0.006/Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°
- ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´ (gpt-4o-mini): ~$0.0005/ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
- **ĞŸÑ€Ğ¸ 100 Ğ³Ğ¾Ğ»Ğ¾ÑĞ¾Ğ²Ñ‹Ñ…/Ğ´ĞµĞ½ÑŒ (ÑÑ€ĞµĞ´Ğ½Ğ¸Ğµ 10 ÑĞµĞº): ~$0.10/Ğ´ĞµĞ½ÑŒ = ~$3/Ğ¼ĞµÑ**

---

## ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

### Batch translation
Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ° Ğ½Ğ° Ğ²ÑĞµ ÑĞ·Ñ‹ĞºĞ¸ ÑÑ€Ğ°Ğ·Ñƒ â€” Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° ÑĞ·Ñ‹ĞºĞ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹. Ğ’ direct Ñ‡Ğ°Ñ‚Ğ°Ñ… ÑÑ‚Ğ¾ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 1 Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´.

### Translation cache
ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ÑÑÑ‰Ğ¸ĞµÑÑ Ñ„Ñ€Ğ°Ğ·Ñ‹ ("Hello", "Thank you", "How much?") â€” ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°.

### Language detection
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `preferred_language` Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ auto-detect (Ğ´ĞµÑˆĞµĞ²Ğ»Ğµ Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ Ğ´Ğ»Ñ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹).

### Offline queue
Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ ÑĞµÑ‚Ğ¸ â€” ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸.
