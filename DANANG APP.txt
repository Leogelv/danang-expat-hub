# PROJECT BRIEF: Danang Expat Hub
# PROJECT BRIEF: Danang Expat Hub


## 🎯 Проблема


### **Что не так:**
Экспаты в Дананге сталкиваются с **информационным хаосом и фрагментацией сервисов**. Для решения базовых задач (найти жильё, байк, друзей, кафе) нужно:
- Мониторить 10+ телеграм-чатов с потоком из сотен сообщений в день
- Искать информацию в закрытых Facebook-группах на вьетнамском языке
- Доверять непроверенным источникам (риск мошенничества)
- Тратить часы на поиск актуальных рекомендаций


**Конкретная ситуация:**
Новорприбывший цифровой кочевник ищет квартиру на 3 месяца. Он:
1. Листает 500+ сообщений в телеграм-чате "Danang Expats"
2. Находит 3 варианта, но не знает актуальны ли они
3. Пишет арендодателю → ответа нет или цена завышена для иностранца
4. Теряет 2-3 дня на поиски, живя в дорогом отеле
5. В итоге берёт первый "нормальный" вариант, переплачивая 30%


### **Для кого это:**
**Основная аудитория:** Экспаты и цифровые кочевники в Дананге (Вьетнам)


**Боли:**
- **Новички (0-3 месяца):** паника, не знаю с чего начать, языковой барьер
- **Опытные (3+ месяца):** скука, поверхностные связи, поиск качественных рекомендаций
- **Цифровые кочевники:** одиночество, нужен нетворкинг и быстрые решения
- **Вьетнамские бизнесы:** сложно достучаться до платёжеспособных иностранцев


### **Как сейчас решают:**


| **Задача** | **Текущее решение** | **Почему не работает** |
|------------|---------------------|------------------------|
| **Долгосрочная аренда жилья/байков** | Booking, Airbnb, телеграм-чаты, Facebook | ❌ Booking/Airbnb ориентированы на туристов<br>❌ В чатах хаос, спам, устаревшие объявления<br>❌ Facebook требует знания вьетнамского |
| **Поиск информации (кафе, врачи, обмен валюты)** | Телеграм-чаты, закрытые FB-группы, Google Maps | ❌ Информация устаревает<br>❌ Нужно листать 1000 сообщений<br>❌ Нет персонализации (веган не найдёт веган-кафе быстро) |
| **Комьюнити и события** | Telegram-чаты, Threads, Meetup | ❌ Threads глобальный, не локальный<br>❌ Пассивное общение, нет мэтчинга по интересам<br>❌ Meetup не популярен в Азии |
| **Барахолка** | Телеграм-чаты | ❌ Сообщения теряются в ленте<br>❌ Нет поиска и фильтров<br>❌ Сложно договориться о встрече |


---


## 👥 Целевая аудитория


### **Основная:**


#### **Сегмент 1: Новички-экспаты (0-3 месяца в Дананге)**
- **Кто:** Первый раз в Азии, только прилетели
- **Возраст:** 25-40 лет
- **Профессия:** Remote workers, фрилансеры, предприниматели
- **Tech-уровень:** Средний-высокий (активные пользователи Telegram)
- **Боли:** 
  - Паника: "Где жить? Где взять байк? Как снять деньги?"
  - Языковой барьер
  - Страх мошенничества
- **Цели:** 
  - За 1-2 дня решить базовые вопросы (жильё, транспорт)
  - Найти первых знакомых
  - Не переплатить за услуги


#### **Сегмент 2: Цифровые кочевники (1-6 месяцев stay)**
- **Кто:** Опытные travellers, работают удалённо
- **Возраст:** 28-45 лет
- **Профессия:** Разработчики, дизайнеры, маркетологи, предприниматели
- **Tech-уровень:** Высокий
- **Боли:**
  - Одиночество (поверхностные знакомства)
  - Нужен профессиональный нетворкинг
  - Поиск качественных мест (коворкинги, кафе)
- **Цели:**
  - Найти единомышленников для коллабораций
  - Присоединиться к интересным событиям
  - Получить insider-рекомендации


#### **Сегмент 3: Долгосрочные экспаты (6+ месяцев)**
- **Кто:** Живут в Дананге постоянно или регулярно возвращаются
- **Возраст:** 30-55 лет
- **Профессия:** Владельцы бизнеса, консультанты, учителя
- **Боли:**
  - Хотят быть частью структурированного комьюнити
  - Готовы делиться знаниями
  - Ищут глубокие связи
- **Цели:**
  - Стать амбассадорами/контрибьюторами
  - Монетизировать экспертизу
  - Организовывать события


### **Вторичная аудитория:**


#### **Вьетнамские бизнесы и арендодатели**
- **Кто:** Владельцы кафе, коворкингов, арендных вилл/байков
- **Боли:**
  - Сложно достучаться до иностранцев (языковой барьер)
  - Зависимость от сарафанного радио
  - Нет инструментов для управления объявлениями
- **Цели:**
  - Получить поток качественных клиентов
  - Автоматизировать размещение объявлений
  - Получить отзывы от экспатов


---


## 💎 Ценностное предложение


### **Главная польза:**
**"Решаем ВСЕ проблемы экспата в Дананге за 5 минут диалога с AI-ассистентом"**


#### **Для экспатов:**
- 🤖 **AI-ассистент знает всё:** Спросил "где снять виллу на 3 месяца до $500" → получил 5 проверенных вариантов с контактами
- 🏠 **Долгосрочная аренда:** Не туристические варианты, а реальное жильё для жизни
- 👥 **Умный мэтчинг:** AI находит единомышленников по интересам ("найди мне python-разработчиков для хакатона")
- 📅 **Структурированные события:** Не хаос в чатах, а календарь встреч с регистрацией
- 🛒 **Барахолка с поиском:** Нужен монитор? AI найдёт в объявлениях и даже предложит похожие варианты
- 🍜 **Персонализированные рекомендации:** "Я веган и люблю specialty coffee" → AI даёт топ-5 мест


#### **Для вьетнамских бизнесов:**
- 🎯 **Прямой доступ к платёжеспособной аудитории:** 10,000+ экспатов в одном месте
- 🤖 **AI-помощник в публикации:** Загрузил фото виллы → AI создал описание на английском
- 📊 **Аналитика:** Видят сколько людей посмотрели, написали, забронировали


### **Отличие от аналогов:**


| **Конкурент** | **Их подход** | **Наше отличие** |
|---------------|---------------|------------------|
| **Telegram-чаты** | Пассивный поток сообщений | 🤖 AI-агрегация всех чатов + умный поиск по всей истории |
| **Facebook группы** | Языковой барьер, хаос | 🌐 Билингвальная платформа, структурированные данные |
| **Booking/Airbnb** | Туристическая аренда | 🏡 Долгосрочная аренда для жизни (1+ месяц) |
| **Meetup/Eventbrite** | Нет локального контента | 📍 Гиперлокальные события + AI-мэтчинг участников |
| **Google Maps** | Общие отзывы туристов | 👥 Отзывы от экспатов + персонализация под вкусы |


**Уникальная фишка:** 
**RAG + MCP-сервер** = AI-ассистент который:
- Парсит ВСЕ экспат-чаты в реальном времени
- Преобразует хаос в структурированную БД
- Отвечает на вопросы с контекстом всего комьюнити
- Умеет мэтчить людей по интересам и потребностям


---


## 🏗️ High-Level решение


### **Общий подход:**
**AI-first экосистема** на базе Telegram Mini-App, где искусственный интеллект:
1. **Агрегирует** информацию из всех существующих источников (чаты, группы)
2. **Структурирует** данные в удобную базу знаний
3. **Рекомендует** персонализированные решения через диалог
4. **Мэтчит** людей по интересам и потребностям
5. **Помогает** вьетнамским бизнесам создавать контент


### **Технологическая основа (для контекста, без деталей):**
- **Платформа:** Telegram Mini-App (доступ без установки, 90% экспатов уже в Telegram)
- **AI-движок:** RAG (Retrieval-Augmented Generation) + MCP-сервер для умного поиска в Supabase
- **Парсинг:** Userbot собирает данные из публичных чатов → AI преобразует в JSON → записывает в БД
- **Билингвальность:** AI переводит контент вьетов на английский и наоборот


### **Ключевые возможности (MVP Roadmap):**


#### **1. Умный AI-ассистент (Killer Feature)**
**Зачем:** Решает 80% вопросов экспата за 1 диалог


**Как работает:**
- Юзер пишет в чат: "Мне нужна квартира-студия в An Thuong, до $400, с бассейном"
- AI анализирует:
  - Актуальные объявления из БД
  - Историю рекомендаций других экспатов
  - Карту районов и цен
- Выдаёт 3-5 вариантов с:
  - Фото, описание, цена
  - Контакт арендодателя
  - Отзывы экспатов
  - Кнопка "Написать владельцу" (прямо в Telegram)


**Покрывает:**
- Аренда жилья (долгосрочная)
- Аренда байков
- Рекомендации кафе/ресторанов/мест
- Услуги (врачи, обмен валюты, доставка)
- Барахолка (поиск товаров)


#### **2. Долгосрочная аренда (Жильё + Байки)**
**Зачем:** Основная боль новичков


**Функции:**
- **Каталог с фильтрами:** район, цена, удобства, срок аренды
- **AI-рекомендации:** "Похоже тебе нужна тихая локация для work-life balance → советую An Thuong"
- **Прямой контакт:** Кнопка "Связаться с арендодателем" (Telegram/WhatsApp/Zalo)
- **Проверенные объявления:** Модерация + отзывы комьюнити
- **Для вьетов:** AI-ассистент помогает создать объявление (загрузил фото → AI написал описание)


#### **3. Комьюнити и события**
**Зачем:** Решает проблему одиночества и нетворкинга


**Функции:**
- **AI-мэтчинг:** "Найди мне разработчиков для хакатона" → список релевантных людей
- **Threads-подобная лента:** Пишешь посты, создаёшь ветки обсуждений
- **Календарь событий:** 
  - Кто угодно создаёт встречу ("Пляжный волейбол, суббота 10:00")
  - Регистрация + подтверждение участия
  - Напоминания за день
- **Сообщества по интересам:** Йога, сёрфинг, программирование, crypto, родители
- **RSVP система:** AI оптимизирует место встречи на основе количества участников


#### **4. Каталог мест (Кафе, рестораны, коворкинги)**
**Зачем:** Персонализированные рекомендации вместо generic Google Maps


**Функции:**
- **Фильтры:** кухня, цена, атмосфера, WiFi, веган/глютен-фри
- **Отзывы экспатов:** Реальные мнения от комьюнити
- **AI-рекомендации:** "Ты любишь specialty coffee + тихие места → вот 3 идеальных кафе"
- **Featured размещение:** Кафе платят за приоритет в выдаче (монетизация)


#### **5. Барахолка**
**Зачем:** Экспаты постоянно покупают/продают вещи при переезде


**Функции:**
- **Простая публикация:** Фото + цена + описание (AI может улучшить текст)
- **Умный поиск:** "Нужен монитор 27 дюймов" → AI находит точные и похожие варианты
- **Категории:** Электроника, мебель, байки, одежда
- **Чат с продавцом:** Встроенный мессенджер


### **Что точно НЕ входит в MVP:**
- ❌ Система бронирования с оплатой (сначала просто контакты)
- ❌ Escrow для транзакций (на барахолке)
- ❌ Видеозвонки для виртуальных туров по виллам
- ❌ Интеграция с банками для оплаты
- ❌ Мобильное приложение (iOS/Android) — только Telegram Mini-App
- ❌ Расширение на другие города (Danang only в MVP)


---


## 🥊 Конкуренты и аналоги


### **Прямые конкуренты:**


#### **1. Telegram-чаты экспатов**
**Примеры:** "Danang Expats", "Digital Nomads Danang", "Danang Buy & Sell"


✅ **Что делают хорошо:**
- Уже есть аудитория (тысячи участников)
- Живое общение, быстрые ответы
- Бесплатно


❌ **Что плохо:**
- Информация теряется в потоке (сообщение актуально 2 часа)
- Нет структуры, поиск не работает
- Спам, дубли, устаревшие объявления
- Нет персонализации


🎯 **Наше преимущество:** 
Мы **агрегируем ВСЕ чаты** через парсинг → AI структурирует → юзер получает актуальную информацию за 1 запрос


#### **2. Facebook группы ("Danang Expat Community", "Expats in Vietnam")**


✅ **Что делают хорошо:**
- Большая аудитория
- Много вьетнамских бизнесов


❌ **Что плохо:**
- Языковой барьер (много контента на вьетнамском)
- Алгоритмы FB скрывают посты
- Неудобный поиск
- Не популярен среди молодых digital nomads


🎯 **Наше преимущество:** 
Билингвальность + AI-перевод. Вьет публикует на вьетнамском → AI переводит → экспат видит на английском


#### **3. Booking.com / Airbnb**


✅ **Что делают хорошо:**
- Удобный интерфейс
- Система отзывов
- Бронирование с гарантией


❌ **Что плохо:**
- Ориентированы на туристов (краткосрочная аренда)
- Высокие цены (комиссия 15-20%)
- Мало долгосрочных вариантов (1+ месяц)


🎯 **Наше преимущество:** 
Фокус на **долгосрочную аренду** для жизни, не туризма. Прямой контакт с арендодателем = цены ниже на 20-40%


### **Непрямые конкуренты:**


#### **4. Google Maps**


✅ **Что делают хорошо:**
- Полная карта всех мест
- Много отзывов


❌ **Что плохо:**
- Отзывы от туристов, не экспатов
- Нет персонализации (веган не найдёт веган-кафе быстро)
- Нет контекста ("это кафе для работы или для романтики?")


🎯 **Наше преимущество:** 
Отзывы от **экспат-комьюнити** + AI-персонализация под вкусы


#### **5. Threads / Reddit**


✅ **Что делают хорошо:**
- Удобный формат обсуждений
- Вирусный контент


❌ **Что плохо:**
- Глобальные, не локальные
- Нет мэтчинга по интересам
- Нет интеграции с локальными сервисами


🎯 **Наше преимущество:** 
**Гиперлокальность** (только Danang) + AI-мэтчинг + интеграция с каталогами и событиями


### **Уникальная ценность:**


**Мы не конкурируем, мы АГРЕГИРУЕМ:**
- Парсим телеграм-чаты → собираем всю информацию
- Структурируем хаос → делаем поиск
- Добавляем AI → даём персонализацию
- Создаём комьюнити → решаем проблему одиночества


**Аналогов нет:** AI-first локальная платформа для экспатов с агрегацией всех источников данных


---


## 🎯 Go-To-Market стратегия


### **Цель:** Привлечь первые 500 активных пользователей за 2 месяца


### **Многоканальный подход:**


#### **1. Платный трафик (Quick win)**
**Каналы:**
- **Telegram Ads:** Реклама в каналах про цифровой кочевничество
- **Facebook Ads:** Таргетинг на экспатов в Дананге (интересы: digital nomad, remote work, Vietnam expat)
- **Instagram Ads:** Таргетинг на travel/lifestyle аудиторию 25-40 лет
- **VK Ads:** Для русскоязычных экспатов


**Креативы:**
- "Только приехал в Дананг? AI найдёт тебе жильё за 5 минут" + скриншот диалога с ботом
- "Устал искать инфу в 10 чатах? Спроси AI-ассистента" + демо


**Бюджет на тест:** $500-1000/месяц
**Ожидаемый CPA:** $2-5 за регистрацию


#### **2. Контент-маркетинг (Долгосрочная стратегия)**
**Форматы:**
- **SEO-гайды:** 
  - "Полный гайд по переезду в Дананг в 2025"
  - "Где жить в Дананге: гид по районам для экспатов"
  - "Сколько стоит жизнь в Дананге: реальный бюджет"
- **YouTube:** Влоги про жизнь в Дананге с интеграцией приложения
- **Medium/Substack:** Истории экспатов


**Интеграция:** В каждом гайде CTA: "Используй наш AI-ассистент для поиска жилья"


#### **3. Community-led рост (Амбассадоры)**
**Стратегия:**
1. Находим 10-20 активных экспатов в существующих чатах
2. Даём им ранний доступ + премиум бесплатно
3. Они:
   - Тестируют функции, дают фидбек
   - Приглашают друзей (реферальная программа)
   - Создают контент (посты, отзывы)
   - Организуют первые события через платформу


**Мотивация:** 
- Статус "Founding Member"
- Пожизненный премиум бесплатно
- Доля от рефералов (если приведёшь 10 друзей → $50 в кредитах на Featured объявления)


#### **4. Органический рост (Threads, Telegram)**
**Тактика:**
- **Threads:** Создаём аккаунт, постим полезный контент про жизнь в Дананге
- **Telegram-чаты:** 
  - Не спамим, а отвечаем на вопросы: "Кстати, я сделал бота который агрегирует все объявления из чатов, хочешь попробовать?"
  - Создаём свой чат, куда приглашаем через value ("Раз в неделю делаем дайджест лучших предложений")


### **План запуска (первые 60 дней):**


**День 0-14: Закрытая бета**
- 20 амбассадоров тестируют
- Собираем фидбек, чиним баги
- Создаём первый контент (10 гайдов, 50 проверенных объявлений)


**День 15-30: Публичный запуск**
- Пост в телеграм-чатах: "Запустили AI-ассистента для экспатов Дананга"
- Платный трафик: $500 на Facebook/Instagram Ads
- PR: Пишем в блоги про digital nomads (Nomad List, Remote Year)
- Цель: 200 регистраций


**День 31-60: Масштабирование**
- Увеличиваем бюджет на рекламу до $1000/месяц
- Амбассадоры приводят рефералов
- Первые вьетнамские бизнесы размещают объявления
- Организуем 2-3 офлайн-встречи через платформу (proof of concept для событий)
- Цель: 500 активных пользователей


---


## 📊 Критерии успеха


### **Через 1 месяц (MVP validation):**
- ✅ **200 регистраций** (экспаты установили Mini-App)
- ✅ **50 активных пользователей** (пользуются минимум раз в неделю)
- ✅ **100+ объявлений** в базе (жильё + байки + барахолка)
- ✅ **500+ запросов к AI-ассистенту**
- ✅ **NPS 40+** (пользователи рекомендуют друзьям)
- ✅ **10 вьетнамских бизнесов** разместили объявления
- ✅ **1 офлайн-событие** организовано через платформу (20+ участников)


### **Через 3 месяца (Product-Market Fit):**
- ✅ **500-1000 регистраций**
- ✅ **200 активных пользователей** (DAU: 50-70)
- ✅ **10 закрытых сделок по аренде** через платформу (proof of value)
- ✅ **50+ отзывов** на места/жильё от комьюнити
- ✅ **5-10 регулярных событий** в месяц (proof of community)
- ✅ **30 вьетнамских бизнесов** в системе
- ✅ **Первые $500 revenue** (комиссия с Featured размещений)
- ✅ **NPS 50+**
- ✅ **Retention 30%+ (Week 4)** — пользователи возвращаются


### **North Star Metric:**
**"Количество успешных решений проблем через AI-ассистента"**


Что считаем:
- Юзер спросил → AI дал рекомендацию → юзер кликнул "Связаться" = SUCCESS
- Цель: 100 успешных решений/неделя к концу 3-го месяца


---


## ⚠️ Ограничения


### **Сроки:**
- **MVP:** 4-6 недель разработки (зависит от сложности AI-парсинга)
- **Запуск:** 2 месяца до 500 пользователей
- **Break-even:** 6-9 месяцев (когда revenue покрывает расходы)


### **Команда:**
- 1-2 человека с Claude Code / Cursor / v0.dev
- Возможно привлечение разработчика на 10-100k ₽ для срочных задач


### **Бюджет:**
- **Инфраструктура:** $20-200/месяц (Supabase, AI API, парсинг-боты)
- **Маркетинг:** $500-2000/месяц на старте (Ads + амбассадоры)
- **Всего на MVP:** $1500-3000 на первые 3 месяца


### **Технические:**
- **Зависимость от Telegram:** Если Mini-Apps изменят политику — риск
- **Парсинг чатов:** Юридическая серая зона (нужно парсить только публичные чаты)
- **AI API costs:** Если пользователей много, расходы на OpenAI/Claude могут вырасти


### **Рыночные:**
- **Гиперлокальность:** Работает только в Дананге (нельзя масштабироваться на другие города без адаптации)
- **Сезонность:** Зимой (ноябрь-март) больше экспатов → летом (апрель-октябрь) меньше


---


## 🚨 Риски


### **Высокие риски:**


#### **1. Cold Start проблема (вероятность: ВЫСОКАЯ)**
**Риск:** Без контента (объявлений, отзывов) AI-ассистент бесполезен → пользователи уходят


**Митигация:**
- ✅ **До запуска:** Парсим существующие чаты, заполняем БД 100+ объявлениями
- ✅ **Амбассадоры:** 20 человек создают первый контент (отзывы на кафе, объявления)
- ✅ **Fake it till you make it:** AI может генерировать рекомендации на основе Google Maps + существующих отзывов


#### **2. Качество AI-рекомендаций (вероятность: СРЕДНЯЯ)**
**Риск:** AI даёт устаревшую/неправильную информацию → потеря доверия


**Митигация:**
- ✅ **Real-time парсинг:** Обновляем данные каждый день
- ✅ **Community validation:** Пользователи могут отметить "Это неактуально"
- ✅ **Human-in-the-loop:** Первые 3 месяца модерируем критичные рекомендации (жильё, врачи)


#### **3. Конкуренция с существующими чатами (вероятность: СРЕДНЯЯ)**
**Риск:** Экспаты привыкли к чатам, не хотят переходить на новую платформу


**Митигация:**
- ✅ **Не конкурируем:** Мы ДОПОЛНЯЕМ чаты (парсим их, делаем информацию доступной)
- ✅ **Удобство:** Поиск в Mini-App за 1 минуту vs листать 500 сообщений
- ✅ **Уникальные фичи:** Мэтчинг по интересам, события с RSVP — этого нет в чатах


### **Средние риски:**


#### **4. Модерация контента (вероятность: СРЕДНЯЯ)**
**Риск:** Спам, мошенники, неадекватные объявления


**Митигация:**
- ✅ **AI-модерация:** Автоматическая проверка текста/фото на спам
- ✅ **Community flagging:** Пользователи могут пожаловаться
- ✅ **Ручная модерация:** Первые 3 месяца проверяем каждое объявление


#### **5. Юридические риски парсинга (вероятность: НИЗКАЯ)**
**Риск:** Telegram/владельцы чатов запретят парсинг


**Митигация:**
- ✅ **Парсим только публичные чаты** (где это разрешено ToS)
- ✅ **Альтернатива:** Если запретят — пользователи сами будут публиковать контент через форму


#### **6. Масштабирование на другие города (вероятность: НИЗКАЯ)**
**Риск:** Успех в Дананге ≠ успех в других локациях


**Митигация:**
- ✅ **Фокус:** Сначала доминируем в Дананге (12-18 месяцев)
- ✅ **Затем:** Копируем модель на Чиангмай, Бали, Медельин


---


## 🎯 Для PM (Product Manager)


### **Рекомендация типа проекта:**
Это **сложный MVP средне-высокой сложности** с амбициозным scope


**Сложность:**
- 🟡 **Средняя:** Базовая функциональность (каталоги, события, барахолка)
- 🔴 **Высокая:** AI-ассистент с RAG + парсинг чатов + мэтчинг


### **Приоритизация для MVP:**


**🚀 ОБЯЗАТЕЛЬНО (v1.0 — первые 4-6 недель):**
1. **AI-ассистент (killer feature):**
   - RAG по базе объявлений/рекомендаций
   - Диалог в Telegram Mini-App
   - Поддержка вопросов: жильё, байки, кафе, барахолка


2. **Каталог долгосрочной аренды:**
   - Жильё (квартиры, виллы, комнаты)
   - Байки
   - Базовые фильтры (цена, район, удобства)
   - Форма для вьетнамских арендодателей (AI-ассистированная публикация)


3. **Барахолка:**
   - Публикация объявлений (фото + текст)
   - Категории (электроника, мебель, etc)
   - Поиск через AI


4. **Парсинг телеграм-чатов:**
   - Userbot собирает сообщения из 5-10 ключевых чатов
   - AI преобразует в JSON → записывает в Supabase
   - Обновление раз в день


**📅 ВАЖНО (v1.1 — через 2 месяца):**
5. **Комьюнити и события:**
   - Создание событий
   - Регистрация + RSVP
   - Календарь встреч
   - Базовая лента (Threads-подобная)


6. **Каталог мест:**
   - Кафе, рестораны, коворкинги
   - Отзывы от экспатов
   - Фильтры (кухня, атмосфера, цена)


**⏳ ПОТОМ (v2.0 — через 3-6 месяцев):**
7. **AI-мэтчинг по интересам**
8. **Featured размещение** (монетизация)
9. **Аналитика для бизнесов**
10. **Билингвальность** (вьетнамская версия)


### **Фокус:**
Начните с **AI-ассистента + каталога аренды + парсинга**. Это закроет главную боль (поиск жилья) и докажет ценность AI.


### **Рекомендуемый подход:**
1. **Неделя 1-2:** Prototype AI-ассистента (минимальный RAG)
2. **Неделя 3-4:** Telegram Mini-App + каталог аренды
3. **Неделя 5-6:** Парсинг чатов + барахолка
4. **Неделя 7-8:** Тестирование с амбассадорами → запуск


### **Критические вопросы для PM:**
1. **Как будем измерять качество AI-рекомендаций?** (accuracy, relevance)
2. **Какой минимальный объём контента нужен для запуска?** (100 объявлений? 50 отзывов?)
3. **Как будем модерировать спам?** (AI + ручная проверка?)
4. **Как будем привлекать вьетнамских арендодателей?** (холодные звонки? партнёрства?)


### **Success Metrics для PM:**
- **Неделя 1:** 50 регистраций, 10 активных пользователей
- **Неделя 4:** 200 регистраций, 50 активных, 5 закрытых сделок
- **Неделя 12:** 500 регистраций, 200 активных, 30 сделок, первый revenue


---


## 📝 Резюме для следующего этапа


### **Что передаём Product Manager:**


✅ **Проблема валидирована:** Экспаты в Дананге страдают от информационного хаоса  
✅ **Аудитория определена:** 3 сегмента (новички, nomads, долгосрочные) + вьетнамские бизнесы  
✅ **Value proposition понятен:** AI-first агрегатор решающий ВСЕ проблемы за 5 минут  
✅ **Конкуренты изучены:** Телеграм-чаты, Facebook группы, Booking — у всех критичные недостатки  
✅ **GTM стратегия есть:** Многоканальный запуск (платный трафик + контент + амбассадоры)  
✅ **Монетизация:** Комиссия с бизнесов + Featured размещение (на старте бесплатно)  
✅ **Риски:** Cold start, качество AI, модерация — все митигированы  


### **Следующий шаг:**
PM создаёт **детальный PRD (Product Requirements Document)** с:
- User stories для каждой фичи
- Wireframes интерфейсов
- Техническими требованиями для Architect
- Roadmap с конкретными сроками
- Acceptance criteria для тестирования


---


**Готово для передачи Product Manager! 🚀**


---


*Документ создан: 2025*  
*Проект: Danang Expat Hub*  
*Автор: Business Analyst Agent*  
*Telegram: @sapientweb*




arch
arch


# ARCHITECTURE: Danang Expat Hub


## 1. Stack & Technologies


* **Frontend:** Next.js 14+ (App Router), TypeScript, Tailwind CSS
* **Architecture:** Feature-Sliced Design (FSD)
* **State Management:** React Query (Server State) + Zustand (Client State для UI)
* **Backend/DB:** Supabase (PostgreSQL, Auth, Storage, Realtime, Edge Functions)
* **AI/ML:** OpenAI GPT-4o (основной LLM), Anthropic Claude 3.5 Sonnet (фоллбэк), OpenAI Embeddings (text-embedding-3-large)
* **Vector DB:** Supabase pgvector extension для RAG
* **Telegram Integration:** Telegram Mini App SDK + Grammy (Bot Framework)
* **Парсинг:** Telethon (Userbot) + BullMQ (очередь задач)
* **UI Kit:** Shadcn/UI (адаптированный под Telegram Mini App theme)
* **Icons:** Lucide React
* **Валидация:** Zod
* **Формы:** React Hook Form


---


## 2. Структура проекта (FSD Strict)


Мы используем строгий FSD. Весь код в `fsd/`.


```text
root/
├── app/                        # Next.js App Router (только роутинг)
│   ├── layout.tsx              # Root Layout + Providers
│   ├── page.tsx                # Proxy к fsd/pages/home
│   ├── listings/               # /listings/:id роуты
│   ├── marketplace/            # /marketplace роуты
│   ├── events/                 # /events роуты
│   └── api/                    # BFF (Backend-for-Frontend)
│       ├── ai/
│       │   └── chat/route.ts   # AI ассистент endpoint
│       ├── listings/
│       │   ├── route.ts        # CRUD для объявлений
│       │   └── [id]/route.ts
│       ├── marketplace/route.ts
│       ├── telegram-webhook/route.ts  # Telegram Bot webhook
│       └── parser/
│           └── trigger/route.ts       # Ручной триггер парсинга
├── fsd/                        # ОСНОВНОЙ КОД
│   ├── app/                    # Providers, Global Styles
│   │   ├── providers/
│   │   │   ├── TelegramProvider.tsx    # Telegram WebApp context
│   │   │   ├── QueryProvider.tsx       # React Query
│   │   │   └── ThemeProvider.tsx       # Theme (Telegram colors)
│   │   └── styles/
│   │       └── globals.css
│   ├── pages/                  # Страницы (собираются из виджетов)
│   │   ├── home/
│   │   │   └── HomePage.tsx            # Главная с AI-чатом
│   │   ├── listings/
│   │   │   ├── ListingsPage.tsx        # Каталог жилья/байков
│   │   │   └── ListingDetailPage.tsx   # Детальная страница объявления
│   │   ├── marketplace/
│   │   │   └── MarketplacePage.tsx     # Барахолка
│   │   ├── events/
│   │   │   └── EventsPage.tsx          # События (v1.1)
│   │   └── profile/
│   │       └── ProfilePage.tsx         # Профиль пользователя
│   ├── widgets/                # Крупные блоки UI
│   │   ├── header/
│   │   │   └── Header.tsx              # Header с навигацией
│   │   ├── ai-chat/
│   │   │   └── AiChatWidget.tsx        # AI-ассистент чат-виджет
│   │   ├── listings-catalog/
│   │   │   ├── ListingsCatalog.tsx     # Каталог с фильтрами
│   │   │   └── ListingsFilters.tsx     # Панель фильтров
│   │   ├── marketplace-feed/
│   │   │   └── MarketplaceFeed.tsx     # Лента барахолки
│   │   └── bottom-nav/
│   │       └── BottomNav.tsx           # Нижняя навигация (Telegram-style)
│   ├── features/               # Сценарии (изменяют состояние)
│   │   ├── ai-assistant/
│   │   │   ├── ui/
│   │   │   │   ├── ChatInput.tsx       # Поле ввода сообщения
│   │   │   │   ├── ChatMessage.tsx     # Сообщение в чате
│   │   │   │   └── ResultCard.tsx      # Карточка результата AI
│   │   │   ├── api/
│   │   │   │   └── useChatMutation.ts  # Mutation для отправки запроса
│   │   │   └── model/
│   │   │       └── types.ts
│   │   ├── create-listing/
│   │   │   ├── ui/
│   │   │   │   ├── CreateListingForm.tsx
│   │   │   │   └── AiAssistButton.tsx   # AI-улучшение описания
│   │   │   └── api/
│   │   │       └── useCreateListing.ts
│   │   ├── listing-filters/
│   │   │   ├── ui/
│   │   │   │   └── FilterPanel.tsx
│   │   │   └── model/
│   │   │       └── filtersStore.ts      # Zustand store для фильтров
│   │   ├── marketplace-search/
│   │   │   └── ui/
│   │   │       └── AiSearchBar.tsx      # Умный поиск по барахолке
│   │   └── contact-seller/
│   │       └── ui/
│   │           └── ContactButton.tsx    # Кнопка "Написать продавцу"
│   ├── entities/               # Бизнес-сущности
│   │   ├── user/
│   │   │   ├── model/
│   │   │   │   └── types.ts             # User, Profile interfaces
│   │   │   ├── ui/
│   │   │   │   ├── UserAvatar.tsx
│   │   │   │   └── UserCard.tsx
│   │   │   └── api/
│   │   │       └── userQueries.ts       # useProfile, useUpdateProfile
│   │   ├── listing/
│   │   │   ├── model/
│   │   │   │   └── types.ts             # Listing interface
│   │   │   ├── ui/
│   │   │   │   ├── ListingCard.tsx      # Карточка объявления
│   │   │   │   └── ListingGallery.tsx   # Галерея фото
│   │   │   └── api/
│   │   │       └── listingQueries.ts    # useListings, useListing
│   │   ├── marketplace-item/
│   │   │   ├── model/
│   │   │   │   └── types.ts
│   │   │   ├── ui/
│   │   │   │   └── MarketplaceCard.tsx
│   │   │   └── api/
│   │   │       └── marketplaceQueries.ts
│   │   ├── event/                       # v1.1
│   │   │   ├── model/
│   │   │   │   └── types.ts
│   │   │   └── ui/
│   │   │       └── EventCard.tsx
│   │   └── place/                       # v1.1 (кафе, рестораны)
│   │       ├── model/
│   │       │   └── types.ts
│   │       └── ui/
│   │           └── PlaceCard.tsx
│   └── shared/                 # UI Kit, API clients, Libs
│       ├── ui/                 # Базовые компоненты (Shadcn/UI)
│       │   ├── button.tsx
│       │   ├── input.tsx
│       │   ├── card.tsx
│       │   ├── dialog.tsx
│       │   ├── select.tsx
│       │   ├── textarea.tsx
│       │   └── badge.tsx
│       ├── api/
│       │   ├── supabase.ts              # Supabase client
│       │   ├── openai.ts                # OpenAI client (для Edge Functions)
│       │   └── telegram.ts              # Telegram Bot API wrapper
│       ├── lib/
│       │   ├── utils.ts                 # Утилиты (cn, formatDate, etc)
│       │   ├── rag/
│       │   │   ├── embeddings.ts        # Генерация embeddings
│       │   │   ├── search.ts            # Векторный поиск
│       │   │   └── prompts.ts           # Промпты для AI
│       │   └── validators/
│       │       ├── listing.ts           # Zod схемы для листингов
│       │       └── marketplace.ts
│       ├── config/
│       │   └── constants.ts             # Константы (районы, категории)
│       └── hooks/
│           ├── useTelegram.ts           # Хук для Telegram WebApp API
│           └── useDebounce.ts
├── supabase/
│   ├── migrations/             # SQL файлы
│   │   ├── 20250101_init.sql
│   │   ├── 20250102_listings.sql
│   │   ├── 20250103_marketplace.sql
│   │   ├── 20250104_embeddings.sql
│   │   └── 20250105_rls.sql
│   └── functions/              # Edge Functions
│       ├── ai-chat/
│       │   └── index.ts                 # AI ассистент (RAG)
│       └── ai-translate/
│           └── index.ts                 # Перевод для вьетнамцев
├── parser/                     # Telegram Userbot (отдельный сервис)
│   ├── src/
│   │   ├── index.ts                     # Главный файл
│   │   ├── parsers/
│   │   │   ├── housingParser.ts         # Парсер жилья
│   │   │   ├── bikeParser.ts            # Парсер байков
│   │   │   └── marketplaceParser.ts     # Парсер барахолки
│   │   ├── ai/
│   │   │   └── messageToJson.ts         # AI преобразование msg → JSON
│   │   ├── queue/
│   │   │   └── bullmq.ts                # Очередь задач
│   │   └── db/
│   │       └── supabase.ts              # Запись в Supabase
│   ├── Dockerfile
│   └── package.json
├── public/
│   └── telegram-icon.png
└── .env.local
```


---


## 3. Схема данных (Supabase PostgreSQL)


### Tables


#### **3.1. users / profiles**


```sql
-- Управляется Supabase Auth, создаём публичную копию профиля
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  telegram_id BIGINT UNIQUE NOT NULL,
  username TEXT,
  first_name TEXT,
  last_name TEXT,
  avatar_url TEXT,
  language_code TEXT DEFAULT 'en',
  is_premium BOOLEAN DEFAULT false,
  is_ambassador BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE INDEX idx_profiles_telegram_id ON profiles(telegram_id);
```


#### **3.2. listings (Жильё + Байки)**


```sql
CREATE TYPE listing_type AS ENUM ('housing', 'bike');
CREATE TYPE listing_status AS ENUM ('active', 'inactive', 'archived');


CREATE TABLE public.listings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  owner_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  type listing_type NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  price_usd INTEGER NOT NULL,  -- Цена в долларах
  location TEXT NOT NULL,  -- Район (An Thuong, My Khe, etc)
  address TEXT,
  lat DECIMAL(10, 8),
  lng DECIMAL(11, 8),
  photos TEXT[] DEFAULT '{}',  -- Массив URL фото
  amenities TEXT[] DEFAULT '{}',  -- ["pool", "wifi", "kitchen"]
  bedrooms INTEGER,  -- Для жилья
  bathrooms INTEGER,  -- Для жилья
  bike_type TEXT,  -- Для байков (automatic, semi-automatic, manual)
  contact_telegram TEXT,
  contact_whatsapp TEXT,
  contact_phone TEXT,
  contact_zalo TEXT,
  views_count INTEGER DEFAULT 0,
  status listing_status DEFAULT 'active',
  is_featured BOOLEAN DEFAULT false,  -- Платное размещение
  source TEXT DEFAULT 'manual',  -- manual | parsed
  parsed_chat_id BIGINT,  -- ID чата, откуда спарсили
  parsed_message_id INTEGER,  -- ID сообщения
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ  -- Автоархивирование через 30 дней
);


CREATE INDEX idx_listings_type ON listings(type);
CREATE INDEX idx_listings_location ON listings(location);
CREATE INDEX idx_listings_price ON listings(price_usd);
CREATE INDEX idx_listings_status ON listings(status);
CREATE INDEX idx_listings_created_at ON listings(created_at DESC);
```


#### **3.3. marketplace (Барахолка)**


```sql
CREATE TYPE marketplace_category AS ENUM ('electronics', 'furniture', 'bikes', 'clothing', 'other');
CREATE TYPE item_condition AS ENUM ('new', 'like_new', 'used', 'needs_repair');


CREATE TABLE public.marketplace (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  seller_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  price_usd INTEGER NOT NULL,
  category marketplace_category NOT NULL,
  condition item_condition NOT NULL,
  photos TEXT[] DEFAULT '{}',
  contact_telegram TEXT,
  contact_whatsapp TEXT,
  views_count INTEGER DEFAULT 0,
  status listing_status DEFAULT 'active',
  source TEXT DEFAULT 'manual',
  parsed_chat_id BIGINT,
  parsed_message_id INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ
);


CREATE INDEX idx_marketplace_category ON marketplace(category);
CREATE INDEX idx_marketplace_price ON marketplace(price_usd);
CREATE INDEX idx_marketplace_status ON marketplace(status);
```


#### **3.4. embeddings (Для RAG векторного поиска)**


```sql
-- Включаем pgvector extension
CREATE EXTENSION IF NOT EXISTS vector;


CREATE TABLE public.embeddings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  content TEXT NOT NULL,  -- Оригинальный текст
  embedding VECTOR(3072),  -- OpenAI text-embedding-3-large размерность
  metadata JSONB,  -- {"type": "listing", "id": "uuid", "title": "..."}
  created_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE INDEX idx_embeddings_vector ON embeddings USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
CREATE INDEX idx_embeddings_metadata ON embeddings USING gin(metadata);
```


#### **3.5. ai_chat_sessions (История диалогов с AI)**


```sql
CREATE TABLE public.ai_chat_sessions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  messages JSONB DEFAULT '[]',  -- [{"role": "user", "content": "..."}, {"role": "assistant", "content": "..."}]
  last_message_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE INDEX idx_chat_sessions_user ON ai_chat_sessions(user_id);
```


#### **3.6. parsed_messages (Сырые сообщения из чатов)**


```sql
CREATE TABLE public.parsed_messages (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  chat_id BIGINT NOT NULL,
  message_id INTEGER NOT NULL,
  text TEXT,
  photos TEXT[],
  parsed_json JSONB,  -- Результат AI-обработки
  is_processed BOOLEAN DEFAULT false,
  error TEXT,  -- Если не удалось распарсить
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(chat_id, message_id)
);


CREATE INDEX idx_parsed_messages_chat ON parsed_messages(chat_id);
CREATE INDEX idx_parsed_messages_processed ON parsed_messages(is_processed);
```


#### **3.7. events (v1.1 — События)**


```sql
CREATE TYPE event_type AS ENUM ('sports', 'networking', 'party', 'education', 'other');


CREATE TABLE public.events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  organizer_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  event_type event_type NOT NULL,
  location TEXT NOT NULL,
  address TEXT,
  lat DECIMAL(10, 8),
  lng DECIMAL(11, 8),
  starts_at TIMESTAMPTZ NOT NULL,
  max_participants INTEGER,
  participants_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE TABLE public.event_participants (
  event_id UUID REFERENCES events(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  rsvp_status TEXT DEFAULT 'going',  -- going | maybe | not_going
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (event_id, user_id)
);
```


#### **3.8. places (v1.1 — Кафе, коворкинги)**


```sql
CREATE TYPE place_category AS ENUM ('cafe', 'restaurant', 'coworking', 'bar', 'other');


CREATE TABLE public.places (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  category place_category NOT NULL,
  location TEXT NOT NULL,
  address TEXT,
  lat DECIMAL(10, 8),
  lng DECIMAL(11, 8),
  photos TEXT[],
  amenities TEXT[],  -- ["wifi", "vegan", "quiet", "specialty_coffee"]
  price_range TEXT,  -- $ | $$ | $$$
  is_featured BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);


CREATE TABLE public.place_reviews (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  place_id UUID REFERENCES places(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  rating INTEGER CHECK (rating >= 1 AND rating <= 5),
  comment TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```


---


### RLS Policies (Row Level Security)


#### **profiles**
```sql
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;


-- Все могут читать публичные профили
CREATE POLICY "Public profiles are viewable by everyone"
  ON profiles FOR SELECT
  USING (true);


-- Пользователь может обновлять только свой профиль
CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE
  USING (auth.uid() = id);
```


#### **listings**
```sql
ALTER TABLE listings ENABLE ROW LEVEL SECURITY;


-- Активные листинги видны всем
CREATE POLICY "Active listings viewable by everyone"
  ON listings FOR SELECT
  USING (status = 'active');


-- Авторизованные пользователи могут создавать листинги
CREATE POLICY "Authenticated users can create listings"
  ON listings FOR INSERT
  WITH CHECK (auth.uid() = owner_id);


-- Владелец может обновлять/удалять свои листинги
CREATE POLICY "Owners can update own listings"
  ON listings FOR UPDATE
  USING (auth.uid() = owner_id);


CREATE POLICY "Owners can delete own listings"
  ON listings FOR DELETE
  USING (auth.uid() = owner_id);
```


#### **marketplace**
```sql
ALTER TABLE marketplace ENABLE ROW LEVEL SECURITY;


-- Аналогично listings
CREATE POLICY "Active marketplace items viewable by everyone"
  ON marketplace FOR SELECT
  USING (status = 'active');


CREATE POLICY "Authenticated users can create marketplace items"
  ON marketplace FOR INSERT
  WITH CHECK (auth.uid() = seller_id);


CREATE POLICY "Sellers can update own items"
  ON marketplace FOR UPDATE
  USING (auth.uid() = seller_id);
```


#### **ai_chat_sessions**
```sql
ALTER TABLE ai_chat_sessions ENABLE ROW LEVEL SECURITY;


-- Пользователь видит только свои сессии
CREATE POLICY "Users can view own chat sessions"
  ON ai_chat_sessions FOR SELECT
  USING (auth.uid() = user_id);


CREATE POLICY "Users can create own chat sessions"
  ON ai_chat_sessions FOR INSERT
  WITH CHECK (auth.uid() = user_id);


CREATE POLICY "Users can update own chat sessions"
  ON ai_chat_sessions FOR UPDATE
  USING (auth.uid() = user_id);
```


---


## 4. Архитектура компонентов (FSD Mapping)


### Entities (Сущности)


#### **Entity: User** (`fsd/entities/user`)
- **Model:** `types.ts` (Profile interface)
- **UI:** 
  - `UserAvatar.tsx` — Аватар пользователя
  - `UserCard.tsx` — Карточка пользователя (имя, статус амбассадора)
- **API:** `userQueries.ts`
  - `useProfile(userId)` — Получить профиль
  - `useUpdateProfile()` — Обновить профиль


#### **Entity: Listing** (`fsd/entities/listing`)
- **Model:** `types.ts`
  ```typescript
  interface Listing {
    id: string;
    type: 'housing' | 'bike';
    title: string;
    description: string;
    price_usd: number;
    location: string;
    photos: string[];
    amenities: string[];
    owner_id: string;
    // ...
  }
  ```
- **UI:**
  - `ListingCard.tsx` — Карточка в каталоге (фото, цена, район)
  - `ListingGallery.tsx` — Галерея фото (swipeable)
  - `ListingDetails.tsx` — Детальная информация
- **API:** `listingQueries.ts`
  - `useListings(filters)` — Список листингов с фильтрацией
  - `useListing(id)` — Детальная информация
  - `useIncrementViews(id)` — Увеличить счётчик просмотров


#### **Entity: MarketplaceItem** (`fsd/entities/marketplace-item`)
- **Model:** `types.ts` (MarketplaceItem interface)
- **UI:** `MarketplaceCard.tsx`
- **API:** `marketplaceQueries.ts`
  - `useMarketplaceItems(filters)`
  - `useMarketplaceItem(id)`


#### **Entity: Event** (`fsd/entities/event`) — v1.1
- **Model:** `types.ts`
- **UI:** `EventCard.tsx`
- **API:** `eventQueries.ts`


#### **Entity: Place** (`fsd/entities/place`) — v1.1
- **Model:** `types.ts`
- **UI:** `PlaceCard.tsx`
- **API:** `placeQueries.ts`


---


### Features (Фичи)


#### **Feature: AI Assistant** (`fsd/features/ai-assistant`)
**Описание:** Диалог с AI-ассистентом через RAG


**UI:**
- `ChatInput.tsx` — Поле ввода сообщения
- `ChatMessage.tsx` — Сообщение (от юзера или AI)
- `ResultCard.tsx` — Карточка результата (листинг/место) с кнопкой "Связаться"


**API:**
- `useChatMutation.ts` — Mutation для отправки сообщения в AI
  ```typescript
  const { mutate: sendMessage } = useChatMutation();
  
  sendMessage({ message: "Найди квартиру в An Thuong" }, {
    onSuccess: (response) => {
      // response содержит AI ответ + карточки результатов
    }
  });
  ```


**Логика:**
- Отправляет запрос в `/api/ai/chat`
- Backend (Edge Function) делает RAG поиск в Supabase
- Возвращает текстовый ответ + массив результатов (listings/places)


#### **Feature: Create Listing** (`fsd/features/create-listing`)
**Описание:** Создание объявления с AI-помощником


**UI:**
- `CreateListingForm.tsx` — Форма (React Hook Form + Zod)
- `AiAssistButton.tsx` — Кнопка "Улучшить описание с AI"
- `PhotoUploader.tsx` — Загрузка фото в Supabase Storage


**API:**
- `useCreateListing.ts` — Mutation
- `useAiImproveDescription.ts` — Вызов AI для улучшения текста


**Логика:**
1. Пользователь заполняет форму (название, описание, цена, фото)
2. Кликает "Улучшить описание" → отправляется в `/api/ai/translate`
3. AI переводит и улучшает (если вьетнамский язык)
4. Сабмит → создаётся запись в `listings` + генерируется embedding


#### **Feature: Listing Filters** (`fsd/features/listing-filters`)
**Описание:** Фильтрация каталога


**UI:**
- `FilterPanel.tsx` — Панель с select/checkbox фильтрами


**Model:**
- `filtersStore.ts` — Zustand store
  ```typescript
  interface FiltersState {
    type: 'housing' | 'bike' | 'all';
    location: string | null;
    priceMin: number;
    priceMax: number;
    amenities: string[];
    setFilter: (key, value) => void;
    resetFilters: () => void;
  }
  ```


**Логика:**
- Изменение фильтра → обновляется store → React Query refetch с новыми параметрами


#### **Feature: Contact Seller** (`fsd/features/contact-seller`)
**Описание:** Кнопка для связи с продавцом/арендодателем


**UI:**
- `ContactButton.tsx` — Открывает Telegram/WhatsApp deep link


**Логика:**
```typescript
const handleContact = (contactTelegram: string) => {
  window.Telegram.WebApp.openTelegramLink(`https://t.me/${contactTelegram}`);
};
```


#### **Feature: Marketplace Search** (`fsd/features/marketplace-search`)
**Описание:** Умный поиск по барахолке через AI


**UI:**
- `AiSearchBar.tsx` — Поле поиска с AI


**API:**
- `useMarketplaceSearch.ts` — Вызывает `/api/ai/search-marketplace`


**Логика:**
- Юзер пишет "монитор 27 дюймов" → AI ищет в базе + похожие варианты (24", 32")


---


### Widgets (Виджеты)


#### **Widget: Header** (`fsd/widgets/header`)
**Состав:**
- Logo (Shared)
- UserAvatar (Entity/User)
- Navigation links


#### **Widget: AI Chat Widget** (`fsd/widgets/ai-chat`)
**Состав:**
- ChatMessage[] (Feature/AI Assistant)
- ChatInput (Feature/AI Assistant)
- ResultCard[] (Feature/AI Assistant)


**Логика:**
- Подключается к `ai_chat_sessions` через React Query
- Хранит историю диалога
- Отображает результаты как карточки внутри чата


#### **Widget: Listings Catalog** (`fsd/widgets/listings-catalog`)
**Состав:**
- FilterPanel (Feature/Listing Filters)
- ListingCard[] (Entity/Listing)
- Infinite scroll (React Query + Intersection Observer)


**Логика:**
- Загружает листинги через `useListings(filters)`
- При скролле вниз → загружает следующую страницу


#### **Widget: Bottom Nav** (`fsd/widgets/bottom-nav`)
**Состав:**
- 4-5 табов: AI | Жильё | Барахолка | События | Профиль
- Использует `next/navigation` для переключения


---


### Pages (Страницы)


#### **Page: Home** (`fsd/pages/home`)
**Состав:**
- AiChatWidget (Widget)


**Роут:** `/` (app/page.tsx → proxy к fsd/pages/home)


#### **Page: Listings** (`fsd/pages/listings`)
**Состав:**
- ListingsCatalog (Widget)


**Роут:** `/listings`


#### **Page: Listing Detail** (`fsd/pages/listings`)
**Состав:**
- ListingGallery (Entity/Listing)
- ListingDetails (Entity/Listing)
- ContactButton (Feature/Contact Seller)
- Map (Shared/UI)


**Роут:** `/listings/[id]`


#### **Page: Marketplace** (`fsd/pages/marketplace`)
**Состав:**
- AiSearchBar (Feature/Marketplace Search)
- MarketplaceFeed (Widget)


**Роут:** `/marketplace`


---


## 5. Data Flow & API Strategy


### **5.1. Fetching (Чтение данных)**


**Стратегия:** React Query (TanStack Query)


**Пример (useListings):**
```typescript
// fsd/entities/listing/api/listingQueries.ts
import { useQuery } from '@tanstack/react-query';
import { supabase } from '@/fsd/shared/api/supabase';


export const useListings = (filters: ListingFilters) => {
  return useQuery({
    queryKey: ['listings', filters],
    queryFn: async () => {
      let query = supabase
        .from('listings')
        .select('*')
        .eq('status', 'active');


      if (filters.type) query = query.eq('type', filters.type);
      if (filters.location) query = query.eq('location', filters.location);
      if (filters.priceMin) query = query.gte('price_usd', filters.priceMin);
      if (filters.priceMax) query = query.lte('price_usd', filters.priceMax);


      const { data, error } = await query.order('created_at', { ascending: false });
      if (error) throw error;
      return data as Listing[];
    },
    staleTime: 1000 * 60 * 5, // 5 минут
  });
};
```


**Кэширование:**
- `staleTime: 5 минут` для каталогов
- `staleTime: 1 час` для детальных страниц
- Инвалидация при создании/обновлении (через mutations)


### **5.2. Mutations (Изменение данных)**


**Пример (useCreateListing):**
```typescript
// fsd/features/create-listing/api/useCreateListing.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { supabase } from '@/fsd/shared/api/supabase';


export const useCreateListing = () => {
  const queryClient = useQueryClient();


  return useMutation({
    mutationFn: async (data: CreateListingInput) => {
      // 1. Загружаем фото в Supabase Storage
      const photoUrls = await uploadPhotos(data.photos);


      // 2. Создаём запись в БД
      const { data: listing, error } = await supabase
        .from('listings')
        .insert({
          ...data,
          photos: photoUrls,
          owner_id: (await supabase.auth.getUser()).data.user?.id,
        })
        .select()
        .single();


      if (error) throw error;


      // 3. Генерируем embedding для RAG (асинхронно)
      await fetch('/api/embeddings/generate', {
        method: 'POST',
        body: JSON.stringify({ listingId: listing.id }),
      });


      return listing;
    },
    onSuccess: () => {
      // Инвалидируем кэш каталога
      queryClient.invalidateQueries({ queryKey: ['listings'] });
    },
  });
};
```


### **5.3. BFF (Backend-for-Frontend)**


**Когда используем Next.js API Routes:**


1. **Приватная логика** (нельзя делать на клиенте):
   - AI-запросы (скрываем API ключи OpenAI)
   - Модерация контента
   - Генерация embeddings


2. **Сложные операции**:
   - RAG поиск (векторные вычисления)
   - Обработка вебхуков (Telegram Bot)
   - Парсинг сообщений (триггер)


**Пример (AI Chat endpoint):**
```typescript
// app/api/ai/chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { OpenAI } from 'openai';
import { supabase } from '@/fsd/shared/api/supabase';
import { searchSimilarListings } from '@/fsd/shared/lib/rag/search';


const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });


export async function POST(req: NextRequest) {
  const { message, sessionId } = await req.json();


  // 1. Получаем историю диалога
  const { data: session } = await supabase
    .from('ai_chat_sessions')
    .select('messages')
    .eq('id', sessionId)
    .single();


  const messages = session?.messages || [];


  // 2. Генерируем embedding для запроса
  const embedding = await openai.embeddings.create({
    model: 'text-embedding-3-large',
    input: message,
  });


  // 3. Ищем похожие листинги через векторный поиск
  const similarListings = await searchSimilarListings(embedding.data[0].embedding);


  // 4. Формируем контекст для LLM
  const context = similarListings.map(l => 
    `${l.title} - $${l.price_usd} - ${l.location} - ${l.description}`
  ).join('\n');


  // 5. Отправляем в GPT-4
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { role: 'system', content: SYSTEM_PROMPT },
      { role: 'user', content: `Context:\n${context}\n\nUser question: ${message}` },
    ],
  });


  const aiResponse = completion.choices[0].message.content;


  // 6. Сохраняем диалог
  await supabase
    .from('ai_chat_sessions')
    .update({
      messages: [...messages, 
        { role: 'user', content: message },
        { role: 'assistant', content: aiResponse }
      ],
    })
    .eq('id', sessionId);


  // 7. Возвращаем ответ + карточки результатов
  return NextResponse.json({
    message: aiResponse,
    results: similarListings.slice(0, 5),
  });
}
```


### **5.4. Realtime (Supabase Realtime)**


**Использование:**
- **События:** Когда кто-то регистрируется на событие → обновляем счётчик участников в реальном времени
- **Чат (v2.0):** Если добавим встроенный чат между юзерами


**Пример:**
```typescript
// Подписка на изменения в таблице events
const channel = supabase
  .channel('event-participants')
  .on('postgres_changes', 
    { event: 'INSERT', schema: 'public', table: 'event_participants' },
    (payload) => {
      // Обновляем UI
      queryClient.invalidateQueries(['event', payload.new.event_id]);
    }
  )
  .subscribe();
```


---


## 6. Технические решения


### **6.1. Auth (Аутентификация)**


**Стратегия:** Telegram WebApp Auth (без паролей)


**Как работает:**
1. Пользователь открывает Mini-App в Telegram
2. Telegram WebApp API автоматически передаёт `initData` (telegram_id, username)
3. Backend валидирует `initData` через Telegram Bot API
4. Создаём/обновляем профиль в Supabase
5. Генерируем JWT токен для Supabase Auth


**Реализация:**
```typescript
// app/api/auth/telegram/route.ts
import { NextRequest, NextResponse } from 'next/server';
import crypto from 'crypto';
import { supabase } from '@/fsd/shared/api/supabase';


function validateTelegramWebAppData(initData: string, botToken: string): boolean {
  // Проверка подписи по алгоритму Telegram
  const params = new URLSearchParams(initData);
  const hash = params.get('hash');
  params.delete('hash');
  
  const dataCheckString = Array.from(params.entries())
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, value]) => `${key}=${value}`)
    .join('\n');
  
  const secretKey = crypto.createHmac('sha256', 'WebAppData').update(botToken).digest();
  const calculatedHash = crypto.createHmac('sha256', secretKey).update(dataCheckString).digest('hex');
  
  return calculatedHash === hash;
}


export async function POST(req: NextRequest) {
  const { initData } = await req.json();
  
  // Валидация
  if (!validateTelegramWebAppData(initData, process.env.TELEGRAM_BOT_TOKEN!)) {
    return NextResponse.json({ error: 'Invalid data' }, { status: 401 });
  }
  
  const params = new URLSearchParams(initData);
  const user = JSON.parse(params.get('user') || '{}');
  
  // Создаём/обновляем профиль
  const { data: profile } = await supabase
    .from('profiles')
    .upsert({
      telegram_id: user.id,
      username: user.username,
      first_name: user.first_name,
      last_name: user.last_name,
      avatar_url: user.photo_url,
    })
    .select()
    .single();
  
  // Генерируем JWT для Supabase
  const { data: authData } = await supabase.auth.signInWithPassword({
    email: `${user.id}@telegram.user`,  // Виртуальный email
    password: process.env.TELEGRAM_AUTH_SECRET!,
  });
  
  return NextResponse.json({ 
    profile, 
    session: authData.session 
  });
}
```


**Frontend (TelegramProvider):**
```typescript
// fsd/app/providers/TelegramProvider.tsx
import { createContext, useEffect, useState } from 'react';
import { supabase } from '@/fsd/shared/api/supabase';


export const TelegramProvider = ({ children }) => {
  const [isReady, setIsReady] = useState(false);
  
  useEffect(() => {
    const initData = window.Telegram.WebApp.initData;
    
    // Аутентификация
    fetch('/api/auth/telegram', {
      method: 'POST',
      body: JSON.stringify({ initData }),
    })
      .then(res => res.json())
      .then(({ session }) => {
        supabase.auth.setSession(session);
        setIsReady(true);
      });
    
    // Настройка темы Telegram
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
  }, []);
  
  if (!isReady) return <div>Loading...</div>;
  
  return children;
};
```


### **6.2. Forms (Формы)**


**Библиотеки:** React Hook Form + Zod


**Пример (CreateListingForm):**
```typescript
// fsd/features/create-listing/ui/CreateListingForm.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';


const createListingSchema = z.object({
  type: z.enum(['housing', 'bike']),
  title: z.string().min(10, 'Title too short'),
  description: z.string().min(50, 'Description too short'),
  price_usd: z.number().min(1),
  location: z.string(),
  photos: z.array(z.instanceof(File)).min(1, 'Add at least 1 photo'),
});


type CreateListingInput = z.infer<typeof createListingSchema>;


export const CreateListingForm = () => {
  const { register, handleSubmit, formState: { errors } } = useForm<CreateListingInput>({
    resolver: zodResolver(createListingSchema),
  });
  
  const { mutate: createListing } = useCreateListing();
  
  const onSubmit = (data: CreateListingInput) => {
    createListing(data);
  };
  
  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <Input {...register('title')} />
      {errors.title && <span>{errors.title.message}</span>}
      {/* ... */}
    </form>
  );
};
```


### **6.3. Navigation**


**Библиотека:** `next/navigation` (App Router)


**Пример (BottomNav):**
```typescript
// fsd/widgets/bottom-nav/BottomNav.tsx
import { usePathname, useRouter } from 'next/navigation';
import { Home, Building, ShoppingBag, Calendar, User } from 'lucide-react';


export const BottomNav = () => {
  const router = useRouter();
  const pathname = usePathname();
  
  const tabs = [
    { icon: Home, label: 'AI', path: '/' },
    { icon: Building, label: 'Жильё', path: '/listings' },
    { icon: ShoppingBag, label: 'Барахолка', path: '/marketplace' },
    { icon: Calendar, label: 'События', path: '/events' },
    { icon: User, label: 'Профиль', path: '/profile' },
  ];
  
  return (
    <nav className="fixed bottom-0 w-full bg-white border-t">
      <div className="flex justify-around">
        {tabs.map(tab => (
          <button
            key={tab.path}
            onClick={() => router.push(tab.path)}
            className={pathname === tab.path ? 'text-blue-500' : 'text-gray-500'}
          >
            <tab.icon />
            <span>{tab.label}</span>
          </button>
        ))}
      </div>
    </nav>
  );
};
```


### **6.4. AI RAG Implementation**


**Архитектура:**


1. **Генерация embeddings:**
   - При создании листинга → генерируем embedding для `title + description + location + amenities`
   - Сохраняем в таблице `embeddings`


2. **Векторный поиск:**
   - Юзер отправляет запрос → генерируем embedding
   - Ищем похожие в `embeddings` через cosine similarity
   - Возвращаем топ-5 результатов


3. **LLM обработка:**
   - Берём найденные листинги как контекст
   - Отправляем в GPT-4 с системным промптом
   - Получаем human-friendly ответ


**Код (searchSimilarListings):**
```typescript
// fsd/shared/lib/rag/search.ts
import { supabase } from '@/fsd/shared/api/supabase';


export async function searchSimilarListings(embedding: number[], limit = 5) {
  const { data, error } = await supabase.rpc('search_embeddings', {
    query_embedding: embedding,
    match_threshold: 0.7,  // Минимальная схожесть
    match_count: limit,
  });
  
  if (error) throw error;
  
  // Возвращаем полные объекты листингов
  return data;
}
```


**SQL Function (в миграции):**
```sql
CREATE OR REPLACE FUNCTION search_embeddings(
  query_embedding VECTOR(3072),
  match_threshold FLOAT,
  match_count INT
)
RETURNS TABLE (
  id UUID,
  content TEXT,
  metadata JSONB,
  similarity FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    e.id,
    e.content,
    e.metadata,
    1 - (e.embedding <=> query_embedding) AS similarity
  FROM embeddings e
  WHERE 1 - (e.embedding <=> query_embedding) > match_threshold
  ORDER BY e.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```


**Системный промпт:**
```typescript
// fsd/shared/lib/rag/prompts.ts
export const SYSTEM_PROMPT = `
You are a helpful AI assistant for expats in Danang, Vietnam.


Your role:
- Help users find housing, bikes, cafes, services
- Provide personalized recommendations based on context
- Always include price, location, and contact info in your answers
- Be friendly and concise


Context will be provided from our database. If no exact match, suggest similar options.


Always respond in the user's language (English or Russian).
`;
```


### **6.5. Telegram Userbot (Парсинг)**


**Архитектура:**


1. **Userbot** (отдельный Node.js сервис) подключается к Telegram через Telethon/Pyrogram
2. Слушает сообщения из списка чатов
3. Отправляет сообщение в очередь BullMQ
4. Worker обрабатывает очередь:
   - Отправляет текст в OpenAI для извлечения структурированных данных
   - Сохраняет в `parsed_messages` и создаёт `listing`/`marketplace_item`
   - Генерирует embedding


**Код (парсер):**
```typescript
// parser/src/index.ts
import { TelegramClient } from 'telegram';
import { StringSession } from 'telegram/sessions';
import { NewMessage } from 'telegram/events';
import { Queue } from 'bullmq';
import { supabase } from './db/supabase';


const client = new TelegramClient(
  new StringSession(process.env.TELEGRAM_SESSION!),
  parseInt(process.env.TELEGRAM_API_ID!),
  process.env.TELEGRAM_API_HASH!,
  { connectionRetries: 5 }
);


const parseQueue = new Queue('parse-messages', {
  connection: { host: 'localhost', port: 6379 },
});


const TARGET_CHATS = [
  -1001234567890,  // Danang Expats
  -1009876543210,  // Danang Housing
  // ...
];


client.addEventHandler(async (event) => {
  const message = event.message;
  
  // Проверяем что сообщение из целевого чата
  if (!TARGET_CHATS.includes(message.chatId)) return;
  
  // Игнорируем служебные сообщения
  if (!message.text && !message.photo) return;
  
  // Добавляем в очередь
  await parseQueue.add('parse', {
    chatId: message.chatId,
    messageId: message.id,
    text: message.text,
    photos: message.photo ? [message.photo] : [],
  });
}, new NewMessage({}));


await client.start();
console.log('Userbot started');
```


**Worker (обработка очереди):**
```typescript
// parser/src/workers/parseWorker.ts
import { Worker } from 'bullmq';
import OpenAI from 'openai';
import { supabase } from '../db/supabase';


const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });


const worker = new Worker('parse-messages', async (job) => {
  const { chatId, messageId, text, photos } = job.data;
  
  // AI извлечение структурированных данных
  const completion = await openai.chat.completions.create({
    model: 'gpt-4o',
    messages: [
      { 
        role: 'system', 
        content: 'Extract structured data from this message. Return JSON: {"type": "housing|bike|marketplace|other", "title": "...", "price": 123, "location": "...", "description": "..."}' 
      },
      { role: 'user', content: text },
    ],
    response_format: { type: 'json_object' },
  });
  
  const parsed = JSON.parse(completion.choices[0].message.content!);
  
  // Сохраняем в БД
  await supabase.from('parsed_messages').insert({
    chat_id: chatId,
    message_id: messageId,
    text,
    photos,
    parsed_json: parsed,
    is_processed: true,
  });
  
  // Если это объявление → создаём listing
  if (parsed.type === 'housing' || parsed.type === 'bike') {
    await supabase.from('listings').insert({
      type: parsed.type,
      title: parsed.title,
      description: parsed.description,
      price_usd: parsed.price,
      location: parsed.location,
      source: 'parsed',
      parsed_chat_id: chatId,
      parsed_message_id: messageId,
      status: 'active',
    });
  }
});
```


**Деплой:**
- Docker контейнер на VPS (DigitalOcean/Hetzner, $10/месяц)
- Redis для BullMQ
- Cron для периодического рестарта (если упадёт)


### **6.6. Image Upload (Supabase Storage)**


**Стратегия:**
- Клиент загружает фото напрямую в Supabase Storage
- Bucket: `listings-photos` (public read)
- Naming: `{userId}/{timestamp}-{random}.jpg`


**Код:**
```typescript
// fsd/features/create-listing/api/uploadPhotos.ts
import { supabase } from '@/fsd/shared/api/supabase';


export async function uploadPhotos(files: File[]): Promise<string[]> {
  const userId = (await supabase.auth.getUser()).data.user?.id;
  
  const urls = await Promise.all(
    files.map(async (file) => {
      const fileName = `${userId}/${Date.now()}-${Math.random().toString(36)}.jpg`;
      
      const { data, error } = await supabase.storage
        .from('listings-photos')
        .upload(fileName, file);
      
      if (error) throw error;
      
      const { data: { publicUrl } } = supabase.storage
        .from('listings-photos')
        .getPublicUrl(fileName);
      
      return publicUrl;
    })
  );
  
  return urls;
}
```


---


## 7. План развертывания


### **Шаг 1: Создать проект в Supabase**
1. Зарегистрироваться на [supabase.com](https://supabase.com)
2. Создать новый проект: "danang-expat-hub"
3. Выбрать регион: Singapore (ближе к Вьетнаму)
4. Сохранить:
   - `SUPABASE_URL`
   - `SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY` (для server-side операций)


### **Шаг 2: Применить миграции**


```bash
# Установить Supabase CLI
npm install -g supabase


# Логин
supabase login


# Линк к проекту
supabase link --project-ref YOUR_PROJECT_ID


# Применить миграции
supabase db push
```


Миграции:
1. `20250101_init.sql` — profiles, base tables
2. `20250102_listings.sql` — listings table
3. `20250103_marketplace.sql` — marketplace table
4. `20250104_embeddings.sql` — pgvector + embeddings table
5. `20250105_rls.sql` — RLS policies


### **Шаг 3: Настроить .env.local**


```env
# Next.js
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...  # Server-side only


# OpenAI
OPENAI_API_KEY=sk-xxx


# Telegram Bot
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
TELEGRAM_AUTH_SECRET=your-secret-password


# Parser (для отдельного сервиса)
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef123456
TELEGRAM_SESSION=xxx  # Получить через telethon
```


### **Шаг 4: Создать Telegram Bot**


1. Написать [@BotFather](https://t.me/Botfather) в Telegram
2. `/newbot` → "Danang Expat Hub"
3. Получить токен → сохранить в `.env`
4. Настроить:
   ```
   /setdomain → your-app.vercel.app
   /setmenubutton → Open App
   ```


### **Шаг 5: Деплой Next.js на Vercel**


```bash
# Установить Vercel CLI
npm install -g vercel


# Деплой
vercel


# Добавить environment variables в dashboard
# vercel.com → Project Settings → Environment Variables
```


**Environment Variables в Vercel:**
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `OPENAI_API_KEY`
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_AUTH_SECRET`


### **Шаг 6: Деплой парсера (VPS)**


**Вариант A: DigitalOcean Droplet ($12/месяц)**


```bash
# SSH на сервер
ssh root@your-droplet-ip


# Установить Docker
apt update && apt install docker.io docker-compose -y


# Клонировать репо
git clone https://github.com/your-repo/danang-expat-hub.git
cd danang-expat-hub/parser


# Создать .env
cat > .env << EOF
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=xxx
TELEGRAM_SESSION=xxx
SUPABASE_URL=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
OPENAI_API_KEY=xxx
EOF


# Запустить
docker-compose up -d
```


**docker-compose.yml:**
```yaml
version: '3.8'
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  parser:
    build: .
    depends_on:
      - redis
    env_file: .env
    restart: unless-stopped
  
  worker:
    build: .
    command: npm run worker
    depends_on:
      - redis
    env_file: .env
    restart: unless-stopped
```


### **Шаг 7: Мониторинг**


**Sentry (ошибки):**
```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```


**Supabase Dashboard:**
- Logs: SQL queries, API requests
- Metrics: DB size, API calls


**Uptime monitoring:**
- [UptimeRobot](https://uptimerobot.com) — бесплатно до 50 мониторов
- Проверяет `/api/health` каждые 5 минут


---


## 8. Производительность и оптимизация


### **8.1. Кэширование**


**React Query:**
- Каталоги: `staleTime: 5 минут`
- Детальные страницы: `staleTime: 1 час`
- AI ответы: кэшируем на 1 день (если запрос точно повторяется)


**CDN для фото:**
- Supabase Storage автоматически использует CDN
- Можно добавить Cloudflare Images для оптимизации ($5/месяц за 100k запросов)


### **8.2. Lazy Loading**


**Infinite Scroll:**
```typescript
// fsd/widgets/listings-catalog/ListingsCatalog.tsx
import { useInfiniteQuery } from '@tanstack/react-query';
import { useInView } from 'react-intersection-observer';


export const ListingsCatalog = () => {
  const { ref, inView } = useInView();
  
  const { data, fetchNextPage, hasNextPage } = useInfiniteQuery({
    queryKey: ['listings'],
    queryFn: ({ pageParam = 0 }) => fetchListings({ offset: pageParam, limit: 20 }),
    getNextPageParam: (lastPage, pages) => 
      lastPage.length === 20 ? pages.length * 20 : undefined,
  });
  
  useEffect(() => {
    if (inView && hasNextPage) fetchNextPage();
  }, [inView]);
  
  return (
    <div>
      {data?.pages.map(page => 
        page.map(listing => <ListingCard key={listing.id} listing={listing} />)
      )}
      <div ref={ref} />  {/* Trigger для подгрузки */}
    </div>
  );
};
```


**Image Optimization:**
```typescript
// Используем next/image для автоматической оптимизации
import Image from 'next/image';


<Image 
  src={listing.photos[0]} 
  alt={listing.title}
  width={400}
  height={300}
  loading="lazy"
  placeholder="blur"
/>
```


### **8.3. Database Indexes**


Уже созданы в миграциях:
- `idx_listings_type` — для фильтрации по типу
- `idx_listings_location` — для фильтрации по району
- `idx_listings_price` — для сортировки по цене
- `idx_embeddings_vector` — для векторного поиска (ivfflat)


### **8.4. AI Cost Optimization**


**Проблема:** OpenAI API дорогой при масштабе


**Решения:**
1. **Кэширование эмбеддингов:** Не генерируем повторно для одинаковых текстов
2. **Batch обработка:** Парсер обрабатывает сообщения пачками (10 за раз)
3. **Fallback на дешёвую модель:** GPT-4o-mini для простых запросов, GPT-4o для сложных
4. **Лимиты:** Бесплатные пользователи — 10 запросов/день, Premium — безлимит


**Расчёт стоимости:**
- Embedding (text-embedding-3-large): $0.13 / 1M tokens
- GPT-4o: $2.50 / 1M input tokens, $10 / 1M output tokens
- Средний запрос: 500 tokens input + 200 tokens output = $0.003
- 1000 запросов/день = $3/день = $90/месяц


**Оптимизация:** Если > 5000 запросов/день → переходим на self-hosted LLM (Llama 3.1)


---


## 9. Мониторинг и метрики


### **9.1. Application Metrics**


**Amplitude (аналитика):**
```typescript
// fsd/shared/lib/analytics.ts
import * as amplitude from '@amplitude/analytics-browser';


amplitude.init(process.env.NEXT_PUBLIC_AMPLITUDE_KEY!);


export const track = (event: string, properties?: Record<string, any>) => {
  amplitude.track(event, properties);
};


// Использование
track('listing_viewed', { listingId: '123', type: 'housing' });
track('ai_query', { query: 'find apartment', resultCount: 5 });
track('contact_clicked', { listingId: '123' });
```


**События для трекинга:**
- `app_opened` — Открытие Mini-App
- `ai_query` — Запрос к AI (+ query text, result count)
- `listing_viewed` — Просмотр листинга
- `contact_clicked` — Клик "Связаться"
- `listing_created` — Создание объявления
- `filter_applied` — Применение фильтра
- `search_performed` — Поиск в барахолке


### **9.2. Error Tracking (Sentry)**


```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';


Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,  // 10% запросов
  environment: process.env.NODE_ENV,
});
```


### **9.3. Alerts**


**Настроить уведомления в Telegram:**
- Парсер упал → уведомление в Telegram
- AI API вернул ошибку 5 раз подряд → алерт
- БД заполнена > 80% → предупреждение


**Реализация:**
```typescript
// Telegram notification helper
export async function sendAlert(message: string) {
  await fetch(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      chat_id: process.env.ADMIN_TELEGRAM_ID,
      text: `🚨 ALERT: ${message}`,
    }),
  });
}
```


---


## 10. Roadmap (Приоритеты разработки)


### **Sprint 1 (Неделя 1-2): Core AI + Auth**
- [ ] Настроить Supabase проект
- [ ] Telegram WebApp Auth
- [ ] Базовая таблица listings
- [ ] AI-ассистент (минимальный RAG без векторного поиска)
- [ ] Простой чат интерфейс


### **Sprint 2 (Неделя 3-4): Каталог жилья**
- [ ] CRUD для listings
- [ ] Фильтры (район, цена, тип)
- [ ] Детальная страница объявления
- [ ] Загрузка фото в Supabase Storage
- [ ] Форма создания объявления для вьетов


### **Sprint 3 (Неделя 5-6): Парсинг + Барахолка**
- [ ] Telegram Userbot (парсинг чатов)
- [ ] AI преобразование msg → JSON
- [ ] BullMQ очередь
- [ ] Таблица marketplace
- [ ] Умный поиск по барахолке


### **Sprint 4 (Неделя 7-8): Векторный поиск + Тестирование**
- [ ] Добавить pgvector
- [ ] Генерация embeddings для всех листингов
- [ ] Улучшить AI-ассистента (RAG с векторным поиском)
- [ ] Closed beta с 20 амбассадорами
- [ ] Фикс критичных багов


### **v1.1 (Месяц 3-4): События + Места**
- [ ] Таблица events + event_participants
- [ ] Создание событий
- [ ] RSVP система
- [ ] Календарь встреч
- [ ] Таблица places (кафе, коворкинги)
- [ ] Отзывы от экспатов


### **v2.0 (Месяц 6+): Монетизация + Мэтчинг**
- [ ] Featured размещение (платные объявления)
- [ ] Stripe интеграция
- [ ] AI-мэтчинг по интересам
- [ ] Рекомендательная система
- [ ] Аналитика для вьетнамских бизнесов
- [ ] Билингвальность (вьетнамская версия)


---


## 11. Риски и митигация


### **Технические риски:**


**1. Парсер может упасть**
- **Митигация:** Docker restart policy + мониторинг + алерты


**2. AI API высокая стоимость**
- **Митигация:** Кэширование + лимиты для бесплатных юзеров + fallback на дешёвую модель


**3. Telegram может заблокировать Userbot**
- **Митигация:** Использовать официальный user account (не bot), парсить только публичные чаты


**4. Supabase Free Tier (500MB)**
- **Митигация:** Оптимизация фото (WebP, resize), удаление старых объявлений (>90 дней), переход на Pro ($25/месяц) при росте


### **Продуктовые риски:**


**1. Экспаты не переходят из чатов**
- **Митигация:** Не конкурируем, а дополняем. Показываем ценность через удобство (поиск за 1 минуту vs листать 500 сообщений)


**2. Качество AI-рекомендаций низкое**
- **Митигация:** Human-in-the-loop первые 3 месяца, сбор фидбека, тонкая настройка промптов


---


## Заключение


Архитектура спроектирована с учётом:


✅ **Масштабируемости:** Легко добавить новые города (отдельные таблицы или партиционирование)  
✅ **Поддерживаемости:** FSD гарантирует понятную структуру кода  
✅ **Производительности:** Кэширование, индексы, векторный поиск  
✅ **Безопасности:** RLS policies, валидация Telegram WebApp, модерация контента  
✅ **AI-first:** RAG + MCP сервер для умных рекомендаций  


**Готово для передачи Dev Team!** 🚀


---


*Архитектурный документ создан: 2025*  
*Проект: Danang Expat Hub*  
*Architect: AI Architect Agent*  
*Контакт PM: @sapientweb*


PRD
# PRD: Danang Expat Hub


**Версия:** 1.0  
**Дата:** 2025  
**Product Manager:** PM Agent  
**Stakeholders:** @sapientweb, Dev Team, Architect  


---


## 📋 Контекст от Analyst


### Проблема:
Экспаты в Дананге сталкиваются с **информационным хаосом**: для решения базовых задач (найти жильё, байк, друзей, услуги) нужно мониторить 10+ телеграм-чатов, искать информацию в закрытых Facebook-группах на вьетнамском, тратить часы на поиск актуальных рекомендаций, рискуя нарваться на мошенников.


### Аудитория:
- **Новички-экспаты** (0-3 месяца): паника, языковой барьер, нужны быстрые решения для жилья/байка
- **Цифровые кочевники** (1-6 месяцев): одиночество, нужен профессиональный нетворкинг и качественные рекомендации
- **Долгосрочные экспаты** (6+ месяцев): хотят структурированное комьюнити, готовы быть контрибьюторами
- **Вьетнамские бизнесы**: сложно достучаться до платёжеспособных иностранцев из-за языкового барьера


### Ценность:
**"Решаем ВСЕ проблемы экспата в Дананге за 5 минут диалога с AI-ассистентом"**


Уникальность: AI-first платформа на Telegram Mini-App, которая **агрегирует** информацию из всех чатов через парсинг, **структурирует** хаос в базу знаний, **рекомендует** персонализированные решения и **мэтчит** людей по интересам.


---


## 🎯 Цели продукта


### Главная цель:
**Стать #1 платформой для экспатов в Дананге, закрывающей все потребности адаптации и жизни через AI-ассистента.**


### Метрики успеха:


**Через 1 месяц (MVP Validation):**
- **200 регистраций** (установок Mini-App)
- **50 активных пользователей** (пользуются минимум раз в неделю)
- **100+ объявлений** в базе (жильё + байки + барахолка)
- **500+ запросов к AI-ассистенту**
- **NPS 40+** (пользователи рекомендуют друзьям)
- **10 вьетнамских бизнесов** разместили объявления
- **1 офлайн-событие** организовано через платформу (20+ участников)


**Через 3 месяца (Product-Market Fit):**
- **500-1000 регистраций**
- **200 активных пользователей** (DAU: 50-70)
- **10 закрытых сделок по аренде** через платформу
- **50+ отзывов** на места/жильё от комьюнити
- **5-10 регулярных событий** в месяц
- **30 вьетнамских бизнесов** в системе
- **Первые $500 revenue** (комиссия с Featured размещений)
- **NPS 50+**
- **Retention 30%+ (Week 4)**


**North Star Metric:**  
**"Количество успешных решений проблем через AI-ассистента"**  
(юзер спросил → AI дал рекомендацию → юзер кликнул "Связаться" = SUCCESS)  
**Цель:** 100 успешных решений/неделю к концу 3-го месяца


---


## 🚀 Функции MVP (v1.0)


### Must-Have (обязательно для запуска)


#### **1. AI-ассистент (Killer Feature)** 🤖
**Зачем:** Решает 80% вопросов экспата за 1 диалог, избавляет от необходимости листать 10 чатов.


**Что делает:**
- Принимает запросы на естественном языке:
  - "Мне нужна квартира-студия в An Thuong, до $400, с бассейном"
  - "Где лучший specialty coffee для работы?"
  - "Кто продаёт монитор 27 дюймов?"
- Анализирует базу данных через RAG (Retrieval-Augmented Generation)
- Выдаёт 3-5 релевантных результатов с:
  - Фото, описание, цена
  - Контакт владельца (кнопка "Написать в Telegram/WhatsApp")
  - Отзывы экспатов (если есть)
  - Ссылка на карту (если локация)


**Покрывает категории:**
- Аренда жилья (долгосрочная)
- Аренда байков
- Рекомендации кафе/ресторанов/мест
- Услуги (врачи, обмен валюты, доставка)
- Барахолка (поиск товаров)


**Технические детали для Architect:**
- RAG-архитектура с MCP-сервером для поиска в Supabase
- Векторный поиск по эмбеддингам (OpenAI/Claude)
- Context window: последние 5 сообщений диалога для персонализации
- Fallback: если нет точного ответа → "Не нашёл в базе, но вот похожие варианты"


**User Flow:**
```
1. Юзер открывает Mini-App → видит чат с AI
2. Пишет запрос: "Мне нужна вилла на 3 месяца"
3. AI уточняет: "В каком районе? Какой бюджет?"
4. Юзер: "An Thuong, до $600"
5. AI показывает 3 варианта с кнопками "Связаться"
6. Юзер кликает → переходит в Telegram-чат с арендодателем
```


**Acceptance Criteria:**
- [ ] AI понимает запросы на английском и русском
- [ ] Время ответа < 5 секунд
- [ ] Точность рекомендаций: 80%+ релевантности (субъективная оценка тестеров)
- [ ] Если нет данных → AI говорит "Пока нет информации, но скоро добавим"
- [ ] Каждый результат содержит кнопку действия (Связаться/Открыть/Посмотреть на карте)


---


#### **2. Каталог долгосрочной аренды (Жильё + Байки)** 🏠🏍️
**Зачем:** Основная боль новичков — найти жильё и транспорт в первые дни.


**Что делает:**


**Для экспатов (поиск):**
- Каталог с карточками объявлений:
  - Фото (галерея до 10 фото)
  - Название + описание
  - Цена ($/месяц)
  - Район (My Khe, An Thuong, Ngu Hanh Son и т.д.)
  - Удобства (WiFi, бассейн, кухня, парковка)
  - Контакт владельца (кнопка "Написать")
- Фильтры:
  - Тип (квартира, вилла, комната / байк полуавтомат/автомат)
  - Цена (от-до)
  - Район (выбор из списка)
  - Удобства (чекбоксы)
  - Срок аренды (1 месяц, 3 месяца, 6+ месяцев)
- Сортировка:
  - По дате (новые сначала)
  - По цене (возрастание/убывание)
  - По популярности (количество просмотров)
- Интеграция с картой (показать на карте района)


**Для вьетнамских владельцев (публикация):**
- Форма создания объявления:
  - Загрузка фото (до 10 шт)
  - Название (AI предлагает варианты на основе типа)
  - Описание (AI-ассистент помогает: "Опиши виллу, я переведу на английский и улучшу текст")
  - Цена
  - Район (выбор из dropdown)
  - Удобства (чекбоксы)
  - Контакты (Telegram/WhatsApp/Zalo/телефон)
- AI-функции:
  - Автоперевод с вьетнамского на английский
  - Улучшение текста ("2-комнатная квартира" → "Cozy 2-bedroom apartment in the heart of An Thuong")
  - Генерация названия на основе характеристик


**User Flow (поиск):**
```
1. Юзер открывает раздел "Жильё"
2. Видит список карточек + кнопку "Фильтры"
3. Применяет фильтр: An Thuong, $300-500, с бассейном
4. Видит 5 результатов
5. Кликает на карточку → открывается детальная страница с галереей
6. Кликает "Написать владельцу" → переход в Telegram
```


**User Flow (публикация для вьета):**
```
1. Владелец открывает "Разместить объявление"
2. Выбирает категорию: Жильё
3. Загружает 5 фото виллы
4. Пишет описание по-вьетнамски: "Villa 2 phòng ngủ gần biển"
5. AI переводит: "2-bedroom villa near the beach" и улучшает
6. Заполняет цену ($500), район (An Thuong), удобства
7. Нажимает "Опубликовать"
8. Объявление попадает в каталог + доступно AI-ассистенту
```


**Acceptance Criteria:**
- [ ] Каталог загружается < 2 секунд
- [ ] Фильтры работают без перезагрузки страницы
- [ ] Каждая карточка содержит минимум 1 фото, цену, район, контакт
- [ ] AI-перевод работает с точностью 90%+ (проверка носителями)
- [ ] Владелец видит статистику: сколько раз посмотрели объявление
- [ ] Модерация: все объявления проверяются AI на спам (автоматическое отклонение подозрительных)


---


#### **3. Барахолка (Buy & Sell)** 🛒
**Зачем:** Экспаты постоянно покупают/продают вещи при переезде (мебель, электроника, байки б/у).


**Что делает:**


**Функции:**
- Публикация объявлений:
  - Фото (до 5 шт)
  - Название
  - Описание
  - Цена ($)
  - Категория (Электроника, Мебель, Байки, Одежда, Другое)
  - Состояние (Новое, Как новое, Б/у, Требует ремонта)
  - Контакт продавца
- Каталог с фильтрами:
  - Категория
  - Цена (от-до)
  - Состояние
  - Дата публикации
- Умный поиск через AI:
  - "Нужен монитор 27 дюймов" → AI находит точные совпадения + похожие (24", 32")
  - "Продаю диван" → AI предлагает категорию "Мебель" и улучшает описание
- Чат с продавцом (переход в Telegram)


**User Flow:**
```
1. Юзер открывает "Барахолка"
2. Видит ленту объявлений (последние 50)
3. Использует поиск: "монитор" или AI-запрос: "Мне нужен монитор для работы"
4. AI показывает 3 варианта: 27" Samsung ($150), 24" LG ($100), 32" ($200)
5. Кликает на карточку → видит детали + кнопку "Написать продавцу"
6. Переходит в Telegram-чат
```


**Acceptance Criteria:**
- [ ] Публикация объявления < 1 минуты
- [ ] AI-поиск возвращает результаты за < 3 секунды
- [ ] Модерация: фото проверяются на NSFW контент (автоматическое отклонение)
- [ ] Каждое объявление содержит дату публикации (автоматически помечается "устаревшим" через 30 дней)
- [ ] Продавец может "поднять" объявление (обновить дату) раз в неделю


---


#### **4. Парсинг телеграм-чатов** 🔄
**Зачем:** Заполнить базу данных актуальной информацией из существующих экспат-чатов без ручного ввода.


**Что делает:**
- **Userbot** (Telegram User Bot) подключается к 5-10 ключевым публичным чатам:
  - "Danang Expats"
  - "Digital Nomads Danang"
  - "Danang Buy & Sell"
  - "Danang Housing"
  - "Danang Motorbike Rental"
- Собирает сообщения в реальном времени (или раз в час)
- **AI-обработка:**
  - Анализирует текст сообщения
  - Определяет тип: объявление (жильё/байк/барахолка), рекомендация (кафе/услуга), вопрос, обсуждение
  - Извлекает структурированные данные:
    ```json
    {
      "type": "housing",
      "title": "2-bedroom apartment in An Thuong",
      "price": 400,
      "location": "An Thuong",
      "contact": "@username",
      "description": "...",
      "amenities": ["pool", "wifi", "kitchen"]
    }
    ```
  - Записывает в Supabase
- **Дедупликация:** Если объявление уже есть в базе → обновляет дату (считается "актуальным")


**Технические детали для Architect:**
- Userbot на Telethon/Pyrogram
- AI-парсинг: Claude/GPT-4 с промптом для извлечения структурированных данных
- Частота обновления: каждый час (настраивается)
- Хранение: raw сообщение + JSON в Supabase
- Модерация: AI помечает подозрительные сообщения (спам, мошенничество) для ручной проверки


**Acceptance Criteria:**
- [ ] Парсинг работает 24/7 без падений
- [ ] Точность извлечения данных: 80%+ (проверка на тестовой выборке из 100 сообщений)
- [ ] Дедупликация: одно объявление не дублируется в базе
- [ ] Сообщения старше 30 дней помечаются "устаревшими" и не показываются в результатах AI
- [ ] Логирование: все ошибки парсинга записываются для дебага


---


### Nice-to-Have (можно добавить после запуска)


#### **5. Комьюнити и события** 📅
**Зачем:** Решает проблему одиночества и нетворкинга.


**Функции (v1.1 — через 2 месяца):**
- Создание событий:
  - Название, описание, дата/время
  - Локация (адрес + карта)
  - Максимум участников
  - Тип (Спорт, Нетворкинг, Вечеринка, Обучение, Другое)
- Регистрация на события:
  - Кнопка "Участвую"
  - RSVP система (подтверждение за 24 часа до события)
  - Напоминания (за день, за час)
- Календарь встреч (список предстоящих событий)
- Threads-подобная лента:
  - Пользователи создают посты
  - Комментарии, лайки
  - Ветки обсуждений


**User Story:**
"Как экспат, я хочу найти единомышленников для игры в волейбол, чтобы не скучать в выходные."


**User Flow:**
```
1. Юзер открывает "События"
2. Видит список: "Пляжный волейбол (суббота 10:00)", "Meetup для разработчиков (среда 18:00)"
3. Кликает "Участвую" на волейбол
4. За день получает напоминание в Telegram
5. В день события видит список участников + чат группы
```


#### **6. AI-мэтчинг по интересам** 🤝
**Зачем:** Находить единомышленников автоматически.


**Функции (v2.0 — через 3-6 месяцев):**
- Профиль пользователя с интересами (тэги: yoga, surfing, python, crypto)
- AI анализирует активность и предлагает:
  - "Похоже ты интересуешься сёрфингом. Вот 5 человек, которые тоже катаются"
  - "У тебя и @username похожие интересы (remote work, specialty coffee). Хотите познакомиться?"
- Групповой мэтчинг: "Найди мне 5 python-разработчиков для хакатона"


#### **7. Каталог мест (Кафе, рестораны, коворкинги)** ☕
**Зачем:** Персонализированные рекомендации вместо generic Google Maps.


**Функции (v1.1 — через 2 месяца):**
- База мест с:
  - Фото, описание, адрес, карта
  - Категории (Кафе, Ресторан, Коворкинг, Бар)
  - Фильтры (кухня, цена, атмосфера, WiFi, веган/глютен-фри)
  - Отзывы экспатов (рейтинг 1-5 звёзд + текст)
- AI-рекомендации:
  - "Ты любишь specialty coffee + тихие места → вот 3 идеальных кафе"
- Featured размещение (монетизация):
  - Кафе платят $20-50/месяц за приоритет в выдаче


---


## 📝 Сценарии использования (User Stories)


### **1. Новичок ищет жильё**
**Персона:** Алексей, 28 лет, разработчик, только прилетел в Дананг


**Сценарий:**
1. Алексей открывает Telegram → видит рекламу "Найдём жильё в Дананге за 5 минут"
2. Кликает → устанавливает Mini-App
3. Видит чат с AI: "Привет! Помогу найти жильё. Какой бюджет и район интересуют?"
4. Алексей: "До $500, хочу рядом с пляжем и кафе"
5. AI: "Советую район An Thuong. Вот 3 варианта: студия $400 с бассейном, 1-bedroom $480 с кухней, вилла $500 с террасой"
6. Алексей смотрит фото, кликает "Написать владельцу" на первый вариант
7. Переходит в Telegram-чат с арендодателем, договаривается о просмотре
8. **Результат:** За 10 минут нашёл 3 варианта вместо 3 дней мониторинга чатов


### **2. Цифровой кочевник ищет коворкинг**
**Персона:** Мария, 32 года, дизайнер, живёт в Дананге 2 месяца


**Сценарий:**
1. Мария открывает AI-ассистента: "Где хороший коворкинг с быстрым интернетом?"
2. AI: "Вот топ-3 по отзывам экспатов: Enouvo Space (100 Mbps, $5/день), WorkHub ($80/месяц, тихо), The Hideout (specialty coffee + WiFi)"
3. Мария кликает на The Hideout → видит фото, адрес на карте, отзывы
4. Читает отзыв: "Лучший кофе в городе, но после 15:00 шумно" (от другого экспата)
5. Сохраняет в избранное, едет туда на следующий день
6. **Результат:** Нашла идеальное место за 2 минуты вместо часа гугления


### **3. Экспат продаёт мебель перед отъездом**
**Персона:** Джон, 35 лет, учитель, уезжает через 2 недели


**Сценарий:**
1. Джон открывает "Барахолка" → "Разместить объявление"
2. Загружает фото дивана, пишет: "Диван IKEA, б/у 6 месяцев, $100"
3. AI предлагает: "Улучшить описание? → 'IKEA sofa in excellent condition, 6 months old, $100. Perfect for small apartment'"
4. Джон соглашается, публикует
5. Через час получает 3 сообщения от заинтересованных
6. Продаёт за 2 дня вместо недели постинга в чатах
7. **Результат:** Быстро нашёл покупателя благодаря умному поиску


### **4. Вьетнамский арендодатель публикует виллу**
**Персона:** Нгуен, 45 лет, владелец 3 вилл в An Thuong


**Сценарий:**
1. Нгуен слышит про платформу от друга-экспата
2. Открывает веб-версию → "Разместить объявление"
3. Загружает 8 фото виллы
4. Пишет описание по-вьетнамски: "Villa 3 phòng ngủ, có hồ bơi, gần biển"
5. AI переводит: "3-bedroom villa with private pool, 5 minutes walk to the beach. Fully furnished, WiFi, parking."
6. Нгуен добавляет цену $600, контакт WhatsApp
7. Публикует → объявление видят 200 экспатов в первый день
8. Получает 5 запросов, сдаёт через неделю
9. **Результат:** Прямой доступ к иностранцам без посредников


---


## ✅ Критерии успеха (Acceptance Criteria)


### **Функциональные:**


**AI-ассистент:**
- [ ] Понимает запросы на английском и русском языках
- [ ] Время ответа < 5 секунд (95% запросов)
- [ ] Точность рекомендаций: 80%+ релевантности (оценка тестеров)
- [ ] Если нет данных → сообщает "Пока нет информации, но скоро добавим"
- [ ] Каждый результат содержит кнопку действия (Связаться/Открыть/Карта)


**Каталог аренды:**
- [ ] Загрузка каталога < 2 секунд
- [ ] Фильтры работают без перезагрузки страницы (SPA-логика)
- [ ] Каждое объявление содержит: минимум 1 фото, цену, район, контакт
- [ ] AI-перевод с вьетнамского на английский работает с точностью 90%+
- [ ] Владелец видит статистику просмотров своего объявления


**Барахолка:**
- [ ] Публикация объявления < 1 минуты (от открытия формы до размещения)
- [ ] AI-поиск возвращает результаты за < 3 секунды
- [ ] Автомодерация: фото проверяются на NSFW контент
- [ ] Объявления старше 30 дней автоматически помечаются "устаревшими"


**Парсинг чатов:**
- [ ] Парсинг работает 24/7 с uptime 99%+
- [ ] Точность извлечения данных: 80%+ (тест на 100 сообщениях)
- [ ] Дедупликация: одно объявление не дублируется
- [ ] Сообщения старше 30 дней не попадают в выдачу AI


### **Качественные (UX):**
- [ ] **Onboarding < 30 секунд:** Юзер понимает как пользоваться с первого запуска
- [ ] **Нулевой интерфейс:** 80% задач решаются через AI-диалог без кликов
- [ ] **Мобильная оптимизация:** Весь интерфейс адаптирован под Telegram Mini-App (viewport 360x640)
- [ ] **Доступность:** Работает на медленном 3G (< 10 секунд загрузки)


### **Бизнес-метрики:**
- [ ] **CAC < $5:** Стоимость привлечения пользователя через платный трафик
- [ ] **Activation Rate 40%+:** Доля установивших, которые сделали минимум 1 запрос к AI
- [ ] **Retention D7: 30%+:** Пользователи возвращаются через неделю
- [ ] **NPS 40+** через месяц, **NPS 50+** через 3 месяца


---


## ⚙️ Ограничения и неfunctional требования


### **Сроки:**
- **MVP (v1.0):** 4-6 недель разработки
  - Неделя 1-2: Prototype AI-ассистента (минимальный RAG)
  - Неделя 3-4: Telegram Mini-App + каталог аренды
  - Неделя 5-6: Парсинг чатов + барахолка
  - Неделя 7-8: Тестирование с амбассадорами → запуск
- **v1.1 (События + Места):** +2 месяца
- **v2.0 (Мэтчинг + Монетизация):** +3-6 месяцев


### **Команда:**
- 1-2 разработчика (вайбкодинг через Claude Code / Cursor / v0.dev)
- Возможность привлечения фрилансера на 10-100k ₽ для критичных задач
- PM (sapientweb) — продуктовые решения, GTM, амбассадоры


### **Бюджет:**
- **Инфраструктура:** $20-200/месяц
  - Supabase: $0-25 (до 500 МБ БД)
  - AI API (OpenAI/Claude): $50-150 (зависит от количества запросов)
  - Telegram Userbot hosting: $10-20
- **Маркетинг:** $500-2000/месяц
  - Ads (Telegram/Facebook/Instagram/VK): $500-1000
  - Амбассадоры: $500 (кредиты + бонусы)
- **Итого на 3 месяца:** $1500-3000


### **Технические ограничения:**
- **Платформа:** Только Telegram Mini-App (нет iOS/Android нативных приложений)
- **Локация:** Только Дананг в MVP (нельзя выбрать другой город)
- **Языки:** Английский + русский для юзеров, вьетнамский для контента (AI-перевод)
- **Парсинг:** Только публичные чаты (юридическая безопасность)
- **Оплаты:** Нет встроенной системы оплаты в MVP (только контакты продавцов/арендодателей)


### **Безопасность:**
- **Модерация контента:**
  - AI автоматически проверяет объявления на спам/мошенничество
  - Фото проверяются на NSFW контент
  - Пользователи могут пожаловаться (флаг "Report")
  - Ручная проверка подозрительных объявлений первые 3 месяца
- **Персональные данные:**
  - Храним только: Telegram ID, username, история запросов к AI (для персонализации)
  - Не храним: телефоны, email, паспортные данные
  - GDPR-compliant: пользователь может удалить все свои данные


---


## 🚫 Что точно НЕ делаем в MVP


**Отложено на v1.1-2.0:**
- ❌ Система бронирования с эскроу (пока только прямой контакт)
- ❌ Видеозвонки для виртуальных туров
- ❌ Интеграция с банками для оплаты
- ❌ Мобильные приложения (iOS/Android)
- ❌ Расширение на другие города (только Danang)
- ❌ Личные кабинеты с расширенной статистикой
- ❌ CRM для вьетнамских бизнесов
- ❌ Партнёрская программа с выплатами
- ❌ Live-чат с поддержкой (пока только FAQ)
- ❌ Продвинутая аналитика для владельцев объявлений


**Почему отложили:**
Это увеличит время разработки на 2-3 месяца, но не критично для валидации гипотезы. Сначала нужно доказать, что экспаты ХОТЯТ пользоваться платформой для поиска жилья и комьюнити.


---


## 📐 Технические требования для Architect


**Ключевые вопросы для проектирования архитектуры:**


### **1. AI-ассистент:**
- Какую модель использовать? (GPT-4, Claude 3.5, Gemini?)
- Как организовать RAG? (векторная БД, embeddings, chunking стратегия)
- Нужен ли MCP-сервер для прямого доступа к Supabase?
- Как хранить историю диалогов? (session management)
- Какой промпт для извлечения intent из запроса юзера?


### **2. Парсинг чатов:**
- На чём запустить Userbot? (VPS, cloud, локальный сервер?)
- Как часто парсить? (real-time vs каждый час)
- Как преобразовывать сообщения в JSON? (промпт для AI, примеры)
- Нужна ли очередь задач? (Celery, BullMQ?)
- Как хранить raw сообщения + JSON? (отдельные таблицы?)


### **3. База данных:**
- Структура таблиц: users, listings (жильё/байки), marketplace (барахолка), messages (парсинг), reviews
- Нужны ли индексы для быстрого поиска?
- Как хранить embeddings для векторного поиска?
- Как реализовать soft delete для устаревших объявлений?


### **4. Telegram Mini-App:**
- Какой фреймворк? (React + Vite, Next.js, Nuxt?)
- Как интегрировать с Telegram Web App API?
- Нужен ли SSR или достаточно CSR?
- Как хранить сессии пользователей?


### **5. Производительность:**
- Как кэшировать результаты AI для частых запросов?
- Нужен ли CDN для фото?
- Как оптимизировать загрузку каталога (pagination, infinite scroll, lazy loading)?


### **6. Мониторинг:**
- Какие логи собирать? (AI запросы, ошибки парсинга, время ответа)
- Как трекать метрики? (Amplitude, Mixpanel, собственная аналитика?)
- Alerts при падении парсинга или high API costs


---


## 📊 Аналитика и метрики (для Dev-команды)


**Что трекаем:**


### **User Acquisition:**
- Регистрации (по каналам: Ads, organic, referral)
- Источники трафика (UTM-метки)


### **Activation:**
- Первый запрос к AI (timing: сразу или через сколько?)
- Первый клик "Связаться" (конверсия в действие)


### **Engagement:**
- DAU / WAU / MAU
- Количество запросов к AI на юзера (среднее)
- Время сессии
- Retention: D1, D7, D30


### **Product Metrics:**
- Топ-5 категорий запросов (жильё, байки, кафе, барахолка, другое)
- Среднее время ответа AI
- Процент запросов без результата ("не нашли данных")
- Процент кликов "Связаться" после рекомендации (success rate)


### **Content Metrics:**
- Количество объявлений (по категориям)
- Количество парсенных сообщений / день
- Процент объявлений старше 30 дней ("мёртвый контент")


### **Business Metrics (после монетизации):**
- MRR (Monthly Recurring Revenue)
- ARPU (Average Revenue Per User)
- LTV (Lifetime Value)
- Payback период для платного трафика


**Инструменты:**
- **Аналитика:** Amplitude (бесплатно до 10M events/месяц) или Mixpanel
- **Логи:** Supabase Logs + Sentry для ошибок
- **A/B тесты (потом):** Split.io или собственная реализация


---


## 🎯 Success Roadmap (что когда измеряем)


### **Неделя 1 (после запуска с амбассадорами):**
- Цель: **20 регистраций, 10 активных**
- Метрика: **NPS 40+** (опрос амбассадоров)
- Действие: Собираем качественный фидбек, чиним критичные баги


### **Неделя 4 (публичный запуск):**
- Цель: **200 регистраций, 50 активных, 100+ объявлений**
- Метрика: **500+ запросов к AI, 50 кликов "Связаться"**
- Действие: Анализируем top запросы, улучшаем промпты AI


### **Неделя 12 (3 месяца):**
- Цель: **500-1000 регистраций, 200 активных**
- Метрика: **10 закрытых сделок по аренде, первые $500 revenue**
- Действие: Принимаем решение о масштабировании (v1.1) или пивоте


---


## 🚀 GTM Execution Plan (для PM)


### **Pre-launch (неделя 0-2):**
1. Находим 20 амбассадоров в существующих чатах
2. Даём ранний доступ, собираем фидбек
3. Заполняем БД: парсим чаты → 100+ объявлений
4. Готовим контент: пишем 3 SEO-гайда, 5 постов для Threads
5. Настраиваем Ads (креативы, таргетинг)


### **Launch (неделя 3-4):**
1. **День 1:** Пост в телеграм-чатах (не спам, а ценность): "Запустили AI-бота для поиска жилья в Дананге. Первым 100 — пожизненный премиум. Тестируйте!"
2. **День 1-7:** Запуск Telegram/Facebook/Instagram Ads ($500 budget)
3. **День 3:** PR в блоги (Nomad List, Remote Year, Reddit r/digitalnomad)
4. **День 7:** Первое офлайн-событие (организуем через платформу → proof of concept)


### **Growth (неделя 5-12):**
1. Увеличиваем бюджет Ads до $1000/месяц
2. Амбассадоры приводят рефералов (бонусы за 10+ приглашений)
3. Контент-маркетинг: публикуем гайды раз в неделю
4. Ретаргетинг: догоняем тех, кто установил но не сделал запрос
5. Партнёрства: договариваемся с вьетнамскими коворкингами о кросс-промо


---


## 🎨 UX/UI Guidelines (для Design/Dev)


### **Принципы:**
1. **AI-first:** 80% задач решаются через диалог, а не клики
2. **Минимализм:** Нет перегруженных экранов, фокус на контенте
3. **Мобильная оптимизация:** Telegram Mini-App = всегда вертикальный viewport
4. **Быстрота:** Всё грузится < 2 секунд на 3G


### **Key Screens:**


**1. Главный экран (Home):**
- Чат с AI (занимает 80% экрана)
- Внизу: табы → "AI", "Жильё", "Барахолка", "Профиль"
- Приветствие: "Привет! Чем помочь? (Жильё / Байк / Кафе / Барахолка)"


**2. Каталог аренды:**
- Карточки с фото (2 колонки grid)
- Фильтры в header (icon → открывается modal)
- Бесконечный скролл


**3. Детальная страница объявления:**
- Галерея фото (swipeable)
- Описание, цена, район, удобства
- Карта (embed Google Maps)
- Кнопка CTA: "Написать владельцу" (primary button)


**4. AI-диалог:**
- Чат-интерфейс (как в Telegram)
- Результаты в виде карточек (inline)
- Кнопки быстрых действий под каждой карточкой


---


## 📞 Stakeholder Communication Plan


### **Weekly Check-ins:**
- **Dev Team ↔ PM:** Прогресс, блокеры, приоритеты
- **PM ↔ Амбассадоры:** Фидбек, новые идеи, баги


### **Bi-weekly:**
- **Все:** Ретроспектива (что работает, что нет)
- **Метрики:** Dashboard с ключевыми показателями (регистрации, активные, запросы к AI)


### **Monthly:**
- **Стратегический пересмотр:** Продолжаем или меняем приоритеты?


---


## ✅ Definition of Done (для каждой фичи)


**Фича считается готовой, когда:**
- [ ] Код написан и прошёл code review
- [ ] Все acceptance criteria выполнены
- [ ] Unit/integration тесты написаны (если критично)
- [ ] Протестировано на реальных устройствах (iOS/Android Telegram)
- [ ] Документация обновлена (README, API docs)
- [ ] PM проверил и одобрил (UAT)
- [ ] Метрики настроены (аналитика трекает события)
- [ ] Развёрнуто в production


---


## 🎯 Итого: Готовность к передаче Architect


**Этот PRD содержит:**
✅ Полное описание всех функций MVP с user stories  
✅ Детальные acceptance criteria для каждой фичи  
✅ Приоритизация (must-have vs nice-to-have)  
✅ Технические вопросы для архитектора  
✅ Метрики успеха и roadmap  
✅ Ограничения и риски  
✅ GTM план и бюджет  


**Architect теперь может:**
- Спроектировать техническую архитектуру
- Выбрать tech stack
- Оценить сложность и сроки
- Начать разработку без вопросов про функционал


---


**Документ готов для передачи Architect! 🚀**


---


*PRD создан: 2025*  
*Проект: Danang Expat Hub*  
*Product Manager: PM Agent*  
*Telegram: @sapientweb*